{"version":3,"file":"viewer.min.js","sources":["../src/viewer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * GEAR Viewer - Main JavaScript module for 3D/AR/VR viewing.\n *\n * @module     mod_gear/viewer\n * @copyright  2026 Boban Blagojevic\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* global THREE */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {\n    'use strict';\n\n    /**\n     * GEAR Viewer class.\n     */\n    class GearViewer {\n        /**\n         * Constructor.\n         *\n         * @param {Object} options Configuration options\n         */\n        constructor(options) {\n            this.cmid = options.cmid;\n            this.gearid = options.gearid;\n            this.config = options.config || {};\n            this.arEnabled = options.ar_enabled || false;\n            this.vrEnabled = options.vr_enabled || false;\n            this.modelsData = options.models || [];\n            this.hotspotsData = options.hotspots || [];\n            this.canManage = options.canmanage || false;\n\n            this.container = document.getElementById('gear-viewer-' + this.cmid);\n            this.canvas = document.getElementById('gear-canvas-' + this.cmid);\n\n            this.isFullscreen = false;\n            this.isAutoRotating = false;\n            this.scene = null;\n            this.camera = null;\n            this.renderer = null;\n            this.controls = null;\n            this.model = null;\n            this.hotspotMeshes = [];\n            this.raycaster = null;\n            this.mouse = new THREE.Vector2();\n\n            this.init();\n        }\n\n        /**\n         * Initialize the viewer.\n         */\n        async init() {\n            try {\n                await this.loadThreeJS();\n                this.setupScene();\n                this.setupControls();\n                this.setupRaycaster();\n                this.setupEventListeners();\n                this.loadModels();\n                this.loadHotspots();\n                this.animate();\n\n                // Dispatch loaded event.\n                var eventDetail = {cmid: this.cmid, gearid: this.gearid};\n                document.dispatchEvent(new CustomEvent('gear:scene:loaded', {detail: eventDetail}));\n            } catch (error) {\n                Notification.exception(error);\n            }\n        }\n\n        /**\n         * Load Three.js library.\n         * Three.js is loaded by PHP before AMD, so just verify it exists.\n         */\n        async loadThreeJS() {\n            // Three.js is loaded via PHP $PAGE->requires->js() before this module.\n            // Just wait for it to be available.\n            if (typeof THREE === 'undefined') {\n                // Wait a bit for scripts to load.\n                await new Promise(resolve => setTimeout(resolve, 500));\n            }\n            if (typeof THREE === 'undefined') {\n                throw new Error('Three.js not loaded. Please check view.php.');\n            }\n        }\n\n        /**\n         * Setup the Three.js scene.\n         */\n        setupScene() {\n            var bgColor;\n            var aspect;\n            var camPos;\n\n            // Create scene.\n            this.scene = new THREE.Scene();\n\n            // Set background color.\n            bgColor = this.config.background || '#1a1a2e';\n            this.scene.background = new THREE.Color(bgColor);\n\n            // Create camera.\n            aspect = this.container.clientWidth / this.container.clientHeight;\n            this.camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);\n            camPos = this.config.camera?.position || [0, 1.6, 3];\n            this.camera.position.set(camPos[0], camPos[1], camPos[2]);\n\n            // Create renderer.\n            this.renderer = new THREE.WebGLRenderer({\n                canvas: this.canvas,\n                antialias: true,\n                alpha: true\n            });\n            this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);\n            this.renderer.setPixelRatio(window.devicePixelRatio);\n            this.renderer.outputEncoding = THREE.sRGBEncoding;\n            this.renderer.xr.enabled = true;\n\n            // Add lighting.\n            this.setupLighting();\n\n            // Add resize handler.\n            window.addEventListener('resize', () => this.onResize());\n        }\n\n        /**\n         * Setup scene lighting.\n         */\n        setupLighting() {\n            var preset = this.config.lighting || 'studio';\n            var ambient;\n            var keyLight;\n            var fillLight;\n            var rimLight;\n            var sunLight;\n            var skyLight;\n            var spotLight;\n\n            // Ambient light.\n            ambient = new THREE.AmbientLight(0xffffff, 0.5);\n            this.scene.add(ambient);\n\n            switch (preset) {\n                case 'studio':\n                    // Key light.\n                    keyLight = new THREE.DirectionalLight(0xffffff, 1);\n                    keyLight.position.set(5, 5, 5);\n                    this.scene.add(keyLight);\n\n                    // Fill light.\n                    fillLight = new THREE.DirectionalLight(0xffffff, 0.5);\n                    fillLight.position.set(-5, 0, 5);\n                    this.scene.add(fillLight);\n\n                    // Rim light.\n                    rimLight = new THREE.DirectionalLight(0xffffff, 0.3);\n                    rimLight.position.set(0, 5, -5);\n                    this.scene.add(rimLight);\n                    break;\n\n                case 'outdoor':\n                    sunLight = new THREE.DirectionalLight(0xffffcc, 1.2);\n                    sunLight.position.set(10, 10, 5);\n                    this.scene.add(sunLight);\n\n                    skyLight = new THREE.HemisphereLight(0x87ceeb, 0x3d5c5c, 0.6);\n                    this.scene.add(skyLight);\n                    break;\n\n                case 'dark':\n                    spotLight = new THREE.SpotLight(0xffffff, 0.8);\n                    spotLight.position.set(0, 5, 0);\n                    this.scene.add(spotLight);\n                    break;\n            }\n        }\n\n        /**\n         * Setup orbit controls.\n         */\n        setupControls() {\n            this.controls = new THREE.OrbitControls(this.camera, this.canvas);\n            this.controls.enableDamping = true;\n            this.controls.dampingFactor = 0.05;\n            this.controls.screenSpacePanning = false;\n            this.controls.minDistance = 0.5;\n            this.controls.maxDistance = 50;\n            this.controls.maxPolarAngle = Math.PI;\n        }\n\n        /**\n         * Setup UI event listeners.\n         */\n        setupEventListeners() {\n            var fullscreenBtn;\n            var autorotateBtn;\n            var arBtn;\n            var vrBtn;\n\n            // Fullscreen button.\n            fullscreenBtn = document.getElementById('gear-fullscreen-' + this.cmid);\n            if (fullscreenBtn) {\n                fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());\n            }\n\n            // Auto-rotate button.\n            autorotateBtn = document.getElementById('gear-autorotate-' + this.cmid);\n            if (autorotateBtn) {\n                autorotateBtn.addEventListener('click', () => this.toggleAutoRotate());\n            }\n\n            // AR button.\n            arBtn = document.getElementById('gear-ar-' + this.cmid);\n            if (arBtn && this.arEnabled) {\n                this.setupARButton(arBtn);\n            }\n\n            // VR button.\n            vrBtn = document.getElementById('gear-vr-' + this.cmid);\n            if (vrBtn && this.vrEnabled) {\n                this.setupVRButton(vrBtn);\n            }\n        }\n\n        /**\n         * Setup AR button with WebXR check.\n         *\n         * @param {HTMLElement} button AR button element\n         */\n        async setupARButton(button) {\n            var supported;\n            if ('xr' in navigator) {\n                supported = await navigator.xr.isSessionSupported('immersive-ar');\n                if (!supported) {\n                    button.disabled = true;\n                    button.title = await Str.get_string('arnotsupported', 'mod_gear');\n                } else {\n                    button.addEventListener('click', () => this.startARSession());\n                }\n            } else {\n                button.disabled = true;\n            }\n        }\n\n        /**\n         * Setup VR button with WebXR check.\n         *\n         * @param {HTMLElement} button VR button element\n         */\n        async setupVRButton(button) {\n            var supported;\n            if ('xr' in navigator) {\n                supported = await navigator.xr.isSessionSupported('immersive-vr');\n                if (!supported) {\n                    button.disabled = true;\n                    button.title = await Str.get_string('webxrnotsupported', 'mod_gear');\n                } else {\n                    button.addEventListener('click', () => this.startVRSession());\n                }\n            } else {\n                button.disabled = true;\n            }\n        }\n\n        /**\n         * Load 3D models from config data.\n         */\n        async loadModels() {\n            var loader;\n            var gltf;\n\n            try {\n                if (this.modelsData && this.modelsData.length > 0) {\n                    loader = new THREE.GLTFLoader();\n\n                    for (const modelData of this.modelsData) {\n                        gltf = await new Promise((resolve, reject) => {\n                            loader.load(modelData.url, resolve, undefined, reject);\n                        });\n\n                        this.model = gltf.scene;\n\n                        // Apply default scale.\n                        this.model.scale.setScalar(1);\n\n                        this.scene.add(this.model);\n\n                        // Center camera on model.\n                        this.centerCameraOnModel(this.model);\n                    }\n\n                    // Mark as loaded.\n                    this.container.classList.add('loaded');\n                } else {\n                    // No models uploaded yet - show placeholder.\n                    this.addPlaceholderModel();\n                    this.container.classList.add('loaded');\n                }\n            } catch (error) {\n                // Error loading model - show placeholder.\n                window.console.error('GEAR: Error loading model:', error);\n                this.addPlaceholderModel();\n                this.container.classList.add('loaded');\n            }\n        }\n\n        /**\n         * Add a placeholder model for testing.\n         */\n        addPlaceholderModel() {\n            var geometry = new THREE.BoxGeometry(1, 1, 1);\n            var material = new THREE.MeshStandardMaterial({\n                color: 0x4a90d9,\n                metalness: 0.3,\n                roughness: 0.4\n            });\n            this.model = new THREE.Mesh(geometry, material);\n            this.scene.add(this.model);\n        }\n\n        /**\n         * Center camera on loaded model.\n         *\n         * @param {Object} model The model to center on\n         */\n        centerCameraOnModel(model) {\n            var box = new THREE.Box3().setFromObject(model);\n            var center = box.getCenter(new THREE.Vector3());\n            var size = box.getSize(new THREE.Vector3());\n\n            var maxDim = Math.max(size.x, size.y, size.z);\n            var fov = this.camera.fov * (Math.PI / 180);\n            var cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));\n            cameraZ *= 1.5; // Add some padding.\n\n            this.camera.position.set(center.x, center.y, center.z + cameraZ);\n            this.controls.target.copy(center);\n            this.controls.update();\n        }\n\n        /**\n         * Animation loop.\n         */\n        animate() {\n            this.renderer.setAnimationLoop(() => {\n                if (this.isAutoRotating && this.model) {\n                    this.model.rotation.y += 0.005;\n                }\n\n                this.controls.update();\n                this.renderer.render(this.scene, this.camera);\n            });\n        }\n\n        /**\n         * Handle window resize.\n         */\n        onResize() {\n            var width = this.container.clientWidth;\n            var height = this.container.clientHeight;\n\n            this.camera.aspect = width / height;\n            this.camera.updateProjectionMatrix();\n            this.renderer.setSize(width, height);\n        }\n\n        /**\n         * Toggle fullscreen mode.\n         */\n        toggleFullscreen() {\n            var container = this.container.closest('.gear-viewer-container');\n            var btn;\n            var icon;\n\n            container.classList.toggle('fullscreen');\n            this.isFullscreen = !this.isFullscreen;\n\n            btn = document.getElementById('gear-fullscreen-' + this.cmid);\n            icon = btn.querySelector('i');\n            icon.classList.toggle('fa-expand', !this.isFullscreen);\n            icon.classList.toggle('fa-compress', this.isFullscreen);\n\n            setTimeout(() => this.onResize(), 100);\n        }\n\n        /**\n         * Toggle auto-rotation.\n         */\n        toggleAutoRotate() {\n            var btn;\n\n            this.isAutoRotating = !this.isAutoRotating;\n\n            btn = document.getElementById('gear-autorotate-' + this.cmid);\n            btn.classList.toggle('active', this.isAutoRotating);\n        }\n\n        /**\n         * Start AR session.\n         */\n        async startARSession() {\n            var session;\n            var eventDetail;\n\n            try {\n                session = await navigator.xr.requestSession('immersive-ar', {\n                    requiredFeatures: ['hit-test', 'local-floor']\n                });\n\n                this.renderer.xr.setSession(session);\n\n                eventDetail = {cmid: this.cmid};\n                document.dispatchEvent(new CustomEvent('gear:ar:started', {detail: eventDetail}));\n\n                this.trackEvent('ar_start');\n            } catch (error) {\n                Notification.exception(error);\n            }\n        }\n\n        /**\n         * Start VR session.\n         */\n        async startVRSession() {\n            var session;\n            var eventDetail;\n\n            try {\n                session = await navigator.xr.requestSession('immersive-vr', {\n                    optionalFeatures: ['local-floor', 'bounded-floor']\n                });\n\n                this.renderer.xr.setSession(session);\n\n                eventDetail = {cmid: this.cmid};\n                document.dispatchEvent(new CustomEvent('gear:vr:started', {detail: eventDetail}));\n\n                this.trackEvent('vr_start');\n            } catch (error) {\n                Notification.exception(error);\n            }\n        }\n\n        /**\n         * Track user events.\n         *\n         * @param {string} action Action name\n         * @param {Object} data Additional data\n         */\n        trackEvent(action, data = {}) {\n            Ajax.call([{\n                methodname: 'mod_gear_track_event',\n                args: {\n                    gearid: this.gearid,\n                    action: action,\n                    data: JSON.stringify(data)\n                }\n            }]);\n        }\n\n        /**\n         * Setup raycaster for click detection.\n         */\n        setupRaycaster() {\n            this.raycaster = new THREE.Raycaster();\n\n            // Click handler for hotspots.\n            this.canvas.addEventListener('click', (event) => {\n                var rect = this.canvas.getBoundingClientRect();\n                this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;\n                this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n\n                this.raycaster.setFromCamera(this.mouse, this.camera);\n\n                // Shift+Click to add new hotspot (managers only).\n                if (event.shiftKey && this.canManage && this.model) {\n                    var modelIntersects = this.raycaster.intersectObject(this.model, true);\n                    if (modelIntersects.length > 0) {\n                        var point = modelIntersects[0].point;\n                        this.showAddHotspotForm(point);\n                        return;\n                    }\n                }\n\n                // Normal click - check hotspots.\n                var intersects = this.raycaster.intersectObjects(this.hotspotMeshes);\n\n                if (intersects.length > 0) {\n                    var hotspotMesh = intersects[0].object;\n                    this.showHotspotPopup(hotspotMesh.userData);\n                }\n            });\n        }\n\n        /**\n         * Load hotspots from data.\n         */\n        loadHotspots() {\n            var geometry;\n            var material;\n            var sphere;\n            var pos;\n\n            if (!this.hotspotsData || this.hotspotsData.length === 0) {\n                return;\n            }\n\n            // Hotspot sphere geometry.\n            geometry = new THREE.SphereGeometry(0.08, 16, 16);\n            material = new THREE.MeshBasicMaterial({\n                color: 0x6366f1,\n                transparent: true,\n                opacity: 0.9\n            });\n\n            for (const hotspot of this.hotspotsData) {\n                sphere = new THREE.Mesh(geometry, material.clone());\n                pos = hotspot.position || {x: 0, y: 0, z: 0};\n                sphere.position.set(pos.x, pos.y, pos.z);\n                sphere.userData = hotspot;\n                this.scene.add(sphere);\n                this.hotspotMeshes.push(sphere);\n            }\n        }\n\n        /**\n         * Show hotspot popup.\n         *\n         * @param {Object} hotspot Hotspot data\n         */\n        showHotspotPopup(hotspot) {\n            var popup = document.getElementById('gear-hotspot-popup-' + this.cmid);\n            var title;\n            var content;\n            var closeBtn;\n\n            if (!popup) {\n                // Create popup if it doesn't exist.\n                popup = document.createElement('div');\n                popup.id = 'gear-hotspot-popup-' + this.cmid;\n                popup.className = 'gear-hotspot-popup';\n                popup.innerHTML = '<div class=\"gear-hotspot-popup-inner\">' +\n                    '<button class=\"gear-hotspot-close\" aria-label=\"Close\">&times;</button>' +\n                    '<h4 class=\"gear-hotspot-title\"></h4>' +\n                    '<div class=\"gear-hotspot-content\"></div>' +\n                    '</div>';\n                this.container.appendChild(popup);\n\n                // Close button handler.\n                closeBtn = popup.querySelector('.gear-hotspot-close');\n                closeBtn.addEventListener('click', () => {\n                    popup.classList.remove('active');\n                });\n            }\n\n            // Update content.\n            title = popup.querySelector('.gear-hotspot-title');\n            content = popup.querySelector('.gear-hotspot-content');\n            title.textContent = hotspot.title || 'Info';\n            content.innerHTML = hotspot.content || '';\n\n            // Show popup.\n            popup.classList.add('active');\n\n            // Track interaction.\n            this.trackInteraction('hotspot_click', {hotspotId: hotspot.id, title: hotspot.title});\n        }\n\n        /**\n         * Show form to add a new hotspot.\n         *\n         * @param {Object} point THREE.Vector3 position\n         */\n        showAddHotspotForm(point) {\n            var form = document.getElementById('gear-hotspot-form-' + this.cmid);\n            var saveBtn;\n            var cancelBtn;\n\n            if (!form) {\n                // Create form.\n                form = document.createElement('div');\n                form.id = 'gear-hotspot-form-' + this.cmid;\n                form.className = 'gear-hotspot-popup active';\n                form.innerHTML = '<div class=\"gear-hotspot-popup-inner gear-hotspot-form-inner\">' +\n                    '<h4 class=\"gear-hotspot-title\">Add Hotspot</h4>' +\n                    '<div class=\"gear-form-group\">' +\n                    '<label for=\"gear-hotspot-input-title-' + this.cmid + '\">Title</label>' +\n                    '<input type=\"text\" id=\"gear-hotspot-input-title-' + this.cmid +\n                    '\" class=\"form-control\" placeholder=\"Enter title\">' +\n                    '</div>' +\n                    '<div class=\"gear-form-group\">' +\n                    '<label for=\"gear-hotspot-input-content-' + this.cmid + '\">Content</label>' +\n                    '<textarea id=\"gear-hotspot-input-content-' + this.cmid +\n                    '\" class=\"form-control\" rows=\"3\" placeholder=\"Enter content\"></textarea>' +\n                    '</div>' +\n                    '<div class=\"gear-form-actions\">' +\n                    '<button type=\"button\" class=\"btn btn-secondary gear-cancel-btn\">Cancel</button>' +\n                    '<button type=\"button\" class=\"btn btn-primary gear-save-btn\">Save</button>' +\n                    '</div>' +\n                    '</div>';\n                this.container.appendChild(form);\n\n                // Cancel button.\n                cancelBtn = form.querySelector('.gear-cancel-btn');\n                cancelBtn.addEventListener('click', () => {\n                    form.classList.remove('active');\n                });\n            } else {\n                // Reset form.\n                form.querySelector('#gear-hotspot-input-title-' + this.cmid).value = '';\n                form.querySelector('#gear-hotspot-input-content-' + this.cmid).value = '';\n                form.classList.add('active');\n            }\n\n            // Store position.\n            form.dataset.posX = point.x.toFixed(3);\n            form.dataset.posY = point.y.toFixed(3);\n            form.dataset.posZ = point.z.toFixed(3);\n\n            // Save button (re-bind to use current position).\n            saveBtn = form.querySelector('.gear-save-btn');\n            saveBtn.onclick = () => this.saveNewHotspot(form);\n        }\n\n        /**\n         * Save a new hotspot via AJAX.\n         *\n         * @param {HTMLElement} form The form element\n         */\n        saveNewHotspot(form) {\n            var titleInput = form.querySelector('#gear-hotspot-input-title-' + this.cmid);\n            var contentInput = form.querySelector('#gear-hotspot-input-content-' + this.cmid);\n            var title = titleInput.value.trim();\n            var content = contentInput.value.trim();\n            var position = {\n                x: parseFloat(form.dataset.posX),\n                y: parseFloat(form.dataset.posY),\n                z: parseFloat(form.dataset.posZ)\n            };\n\n            if (!title) {\n                Notification.alert('Error', 'Please enter a title');\n                return;\n            }\n\n            // Save via AJAX.\n            Ajax.call([{\n                methodname: 'mod_gear_save_hotspot',\n                args: {\n                    id: 0,\n                    gearid: this.gearid,\n                    modelid: 0,\n                    type: 'info',\n                    title: title,\n                    content: content,\n                    position: JSON.stringify(position),\n                    icon: 'info'\n                }\n            }])[0].then((response) => {\n                // Add hotspot mesh.\n                var geometry = new THREE.SphereGeometry(0.08, 16, 16);\n                var material = new THREE.MeshBasicMaterial({\n                    color: 0x6366f1,\n                    transparent: true,\n                    opacity: 0.9\n                });\n                var sphere = new THREE.Mesh(geometry, material);\n                sphere.position.set(position.x, position.y, position.z);\n                sphere.userData = {\n                    id: response.id,\n                    title: title,\n                    content: content,\n                    type: 'info'\n                };\n                this.scene.add(sphere);\n                this.hotspotMeshes.push(sphere);\n\n                // Close form.\n                form.classList.remove('active');\n                Notification.addNotification({\n                    message: 'Hotspot saved successfully',\n                    type: 'success'\n                });\n\n                return response;\n            }).catch(Notification.exception);\n        }\n    }\n\n    return {\n        /**\n         * Initialize the GEAR viewer.\n         *\n         * @param {Object} options Configuration options\n         */\n        init: function(options) {\n            new GearViewer(options);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","GearViewer","constructor","options","cmid","gearid","config","arEnabled","ar_enabled","vrEnabled","vr_enabled","modelsData","models","hotspotsData","hotspots","canManage","canmanage","container","document","getElementById","this","canvas","isFullscreen","isAutoRotating","scene","camera","renderer","controls","model","hotspotMeshes","raycaster","mouse","THREE","Vector2","init","loadThreeJS","setupScene","setupControls","setupRaycaster","setupEventListeners","loadModels","loadHotspots","animate","eventDetail","dispatchEvent","CustomEvent","detail","error","exception","Promise","resolve","setTimeout","Error","bgColor","aspect","camPos","Scene","background","Color","clientWidth","clientHeight","PerspectiveCamera","position","set","WebGLRenderer","antialias","alpha","setSize","setPixelRatio","window","devicePixelRatio","outputEncoding","sRGBEncoding","xr","enabled","setupLighting","addEventListener","onResize","ambient","keyLight","fillLight","rimLight","sunLight","skyLight","spotLight","preset","lighting","AmbientLight","add","DirectionalLight","HemisphereLight","SpotLight","OrbitControls","enableDamping","dampingFactor","screenSpacePanning","minDistance","maxDistance","maxPolarAngle","Math","PI","fullscreenBtn","autorotateBtn","arBtn","vrBtn","toggleFullscreen","toggleAutoRotate","setupARButton","setupVRButton","button","navigator","isSessionSupported","startARSession","disabled","title","get_string","startVRSession","loader","gltf","length","GLTFLoader","modelData","reject","load","url","undefined","scale","setScalar","centerCameraOnModel","classList","addPlaceholderModel","console","geometry","BoxGeometry","material","MeshStandardMaterial","color","metalness","roughness","Mesh","box","Box3","setFromObject","center","getCenter","Vector3","size","getSize","maxDim","max","x","y","z","fov","cameraZ","abs","tan","target","copy","update","setAnimationLoop","rotation","render","width","height","updateProjectionMatrix","icon","closest","toggle","querySelector","session","requestSession","requiredFeatures","setSession","trackEvent","optionalFeatures","action","data","call","methodname","args","JSON","stringify","Raycaster","event","rect","getBoundingClientRect","clientX","left","clientY","top","setFromCamera","shiftKey","modelIntersects","intersectObject","point","showAddHotspotForm","intersects","intersectObjects","hotspotMesh","object","showHotspotPopup","userData","sphere","pos","SphereGeometry","MeshBasicMaterial","transparent","opacity","hotspot","clone","push","content","popup","createElement","id","className","innerHTML","appendChild","remove","textContent","trackInteraction","hotspotId","form","value","dataset","posX","toFixed","posY","posZ","onclick","saveNewHotspot","titleInput","contentInput","trim","parseFloat","modelid","type","then","response","addNotification","message","catch","alert"],"mappings":";;;;;;;AAyBAA,yBAAO,CAAC,SAAU,YAAa,oBAAqB,aAAa,SAASC,EAAGC,KAAMC,aAAcC,WAMvFC,WAMFC,YAAYC,cACHC,KAAOD,QAAQC,UACfC,OAASF,QAAQE,YACjBC,OAASH,QAAQG,QAAU,QAC3BC,UAAYJ,QAAQK,aAAc,OAClCC,UAAYN,QAAQO,aAAc,OAClCC,WAAaR,QAAQS,QAAU,QAC/BC,aAAeV,QAAQW,UAAY,QACnCC,UAAYZ,QAAQa,YAAa,OAEjCC,UAAYC,SAASC,eAAe,eAAiBC,KAAKhB,WAC1DiB,OAASH,SAASC,eAAe,eAAiBC,KAAKhB,WAEvDkB,cAAe,OACfC,gBAAiB,OACjBC,MAAQ,UACRC,OAAS,UACTC,SAAW,UACXC,SAAW,UACXC,MAAQ,UACRC,cAAgB,QAChBC,UAAY,UACZC,MAAQ,IAAIC,MAAMC,aAElBC,8BAQKd,KAAKe,mBACNC,kBACAC,qBACAC,sBACAC,2BACAC,kBACAC,oBACAC,cAGDC,YAAc,CAACvC,KAAMgB,KAAKhB,KAAMC,OAAQe,KAAKf,QACjDa,SAAS0B,cAAc,IAAIC,YAAY,oBAAqB,CAACC,OAAQH,eACvE,MAAOI,OACLhD,aAAaiD,UAAUD,+BAWN,oBAAVf,aAED,IAAIiB,SAAQC,SAAWC,WAAWD,QAAS,OAEhC,oBAAVlB,YACD,IAAIoB,MAAM,+CAOxBhB,qCACQiB,QACAC,OACAC,YAGC/B,MAAQ,IAAIQ,MAAMwB,MAGvBH,QAAUjC,KAAKd,OAAOmD,YAAc,eAC/BjC,MAAMiC,WAAa,IAAIzB,MAAM0B,MAAML,SAGxCC,OAASlC,KAAKH,UAAU0C,YAAcvC,KAAKH,UAAU2C,kBAChDnC,OAAS,IAAIO,MAAM6B,kBAAkB,GAAIP,OAAQ,GAAK,KAC3DC,yCAAcjD,OAAOmB,iEAAQqC,WAAY,CAAC,EAAG,IAAK,QAC7CrC,OAAOqC,SAASC,IAAIR,OAAO,GAAIA,OAAO,GAAIA,OAAO,SAGjD7B,SAAW,IAAIM,MAAMgC,cAAc,CACpC3C,OAAQD,KAAKC,OACb4C,WAAW,EACXC,OAAO,SAENxC,SAASyC,QAAQ/C,KAAKH,UAAU0C,YAAavC,KAAKH,UAAU2C,mBAC5DlC,SAAS0C,cAAcC,OAAOC,uBAC9B5C,SAAS6C,eAAiBvC,MAAMwC,kBAChC9C,SAAS+C,GAAGC,SAAU,OAGtBC,gBAGLN,OAAOO,iBAAiB,UAAU,IAAMxD,KAAKyD,aAMjDF,oBAEQG,QACAC,SACAC,UACAC,SACAC,SACAC,SACAC,UAPAC,OAASjE,KAAKd,OAAOgF,UAAY,gBAUrCR,QAAU,IAAI9C,MAAMuD,aAAa,SAAU,SACtC/D,MAAMgE,IAAIV,SAEPO,YACC,UAEDN,SAAW,IAAI/C,MAAMyD,iBAAiB,SAAU,IACvC3B,SAASC,IAAI,EAAG,EAAG,QACvBvC,MAAMgE,IAAIT,WAGfC,UAAY,IAAIhD,MAAMyD,iBAAiB,SAAU,KACvC3B,SAASC,KAAK,EAAG,EAAG,QACzBvC,MAAMgE,IAAIR,YAGfC,SAAW,IAAIjD,MAAMyD,iBAAiB,SAAU,KACvC3B,SAASC,IAAI,EAAG,GAAI,QACxBvC,MAAMgE,IAAIP,oBAGd,WACDC,SAAW,IAAIlD,MAAMyD,iBAAiB,SAAU,MACvC3B,SAASC,IAAI,GAAI,GAAI,QACzBvC,MAAMgE,IAAIN,UAEfC,SAAW,IAAInD,MAAM0D,gBAAgB,QAAU,QAAU,SACpDlE,MAAMgE,IAAIL,oBAGd,QACDC,UAAY,IAAIpD,MAAM2D,UAAU,SAAU,KAChC7B,SAASC,IAAI,EAAG,EAAG,QACxBvC,MAAMgE,IAAIJ,YAQ3B/C,qBACSV,SAAW,IAAIK,MAAM4D,cAAcxE,KAAKK,OAAQL,KAAKC,aACrDM,SAASkE,eAAgB,OACzBlE,SAASmE,cAAgB,SACzBnE,SAASoE,oBAAqB,OAC9BpE,SAASqE,YAAc,QACvBrE,SAASsE,YAAc,QACvBtE,SAASuE,cAAgBC,KAAKC,GAMvC7D,0BACQ8D,cACAC,cACAC,MACAC,OAGJH,cAAgBnF,SAASC,eAAe,mBAAqBC,KAAKhB,QAE9DiG,cAAczB,iBAAiB,SAAS,IAAMxD,KAAKqF,sBAIvDH,cAAgBpF,SAASC,eAAe,mBAAqBC,KAAKhB,QAE9DkG,cAAc1B,iBAAiB,SAAS,IAAMxD,KAAKsF,sBAIvDH,MAAQrF,SAASC,eAAe,WAAaC,KAAKhB,QACrCgB,KAAKb,gBACToG,cAAcJ,QAIvBC,MAAQtF,SAASC,eAAe,WAAaC,KAAKhB,QACrCgB,KAAKX,gBACTmG,cAAcJ,2BASPK,QAEZ,OAAQC,gBACUA,UAAUrC,GAAGsC,mBAAmB,gBAK9CF,OAAOjC,iBAAiB,SAAS,IAAMxD,KAAK4F,oBAH5CH,OAAOI,UAAW,EAClBJ,OAAOK,YAAclH,IAAImH,WAAW,iBAAkB,aAK1DN,OAAOI,UAAW,sBASNJ,QAEZ,OAAQC,gBACUA,UAAUrC,GAAGsC,mBAAmB,gBAK9CF,OAAOjC,iBAAiB,SAAS,IAAMxD,KAAKgG,oBAH5CP,OAAOI,UAAW,EAClBJ,OAAOK,YAAclH,IAAImH,WAAW,oBAAqB,aAK7DN,OAAOI,UAAW,yBAQlBI,OACAC,YAGIlG,KAAKT,YAAcS,KAAKT,WAAW4G,OAAS,EAAG,CAC/CF,OAAS,IAAIrF,MAAMwF,eAEd,MAAMC,aAAarG,KAAKT,WACzB2G,WAAa,IAAIrE,SAAQ,CAACC,QAASwE,UAC/BL,OAAOM,KAAKF,UAAUG,IAAK1E,aAAS2E,EAAWH,gBAG9C9F,MAAQ0F,KAAK9F,WAGbI,MAAMkG,MAAMC,UAAU,QAEtBvG,MAAMgE,IAAIpE,KAAKQ,YAGfoG,oBAAoB5G,KAAKQ,YAI7BX,UAAUgH,UAAUzC,IAAI,oBAGxB0C,2BACAjH,UAAUgH,UAAUzC,IAAI,UAEnC,MAAOzC,OAELsB,OAAO8D,QAAQpF,MAAM,6BAA8BA,YAC9CmF,2BACAjH,UAAUgH,UAAUzC,IAAI,WAOrC0C,0BACQE,SAAW,IAAIpG,MAAMqG,YAAY,EAAG,EAAG,GACvCC,SAAW,IAAItG,MAAMuG,qBAAqB,CAC1CC,MAAO,QACPC,UAAW,GACXC,UAAW,UAEV9G,MAAQ,IAAII,MAAM2G,KAAKP,SAAUE,eACjC9G,MAAMgE,IAAIpE,KAAKQ,OAQxBoG,oBAAoBpG,WACZgH,KAAM,IAAI5G,MAAM6G,MAAOC,cAAclH,OACrCmH,OAASH,IAAII,UAAU,IAAIhH,MAAMiH,SACjCC,KAAON,IAAIO,QAAQ,IAAInH,MAAMiH,SAE7BG,OAASjD,KAAKkD,IAAIH,KAAKI,EAAGJ,KAAKK,EAAGL,KAAKM,GACvCC,IAAMrI,KAAKK,OAAOgI,KAAOtD,KAAKC,GAAK,KACnCsD,QAAUvD,KAAKwD,IAAIP,OAAS,EAAIjD,KAAKyD,IAAIH,IAAM,IACnDC,SAAW,SAENjI,OAAOqC,SAASC,IAAIgF,OAAOO,EAAGP,OAAOQ,EAAGR,OAAOS,EAAIE,cACnD/H,SAASkI,OAAOC,KAAKf,aACrBpH,SAASoI,SAMlBrH,eACShB,SAASsI,kBAAiB,KACvB5I,KAAKG,gBAAkBH,KAAKQ,aACvBA,MAAMqI,SAASV,GAAK,WAGxB5H,SAASoI,cACTrI,SAASwI,OAAO9I,KAAKI,MAAOJ,KAAKK,WAO9CoD,eACQsF,MAAQ/I,KAAKH,UAAU0C,YACvByG,OAAShJ,KAAKH,UAAU2C,kBAEvBnC,OAAO6B,OAAS6G,MAAQC,YACxB3I,OAAO4I,8BACP3I,SAASyC,QAAQgG,MAAOC,QAMjC3D,uBAGQ6D,KAFYlJ,KAAKH,UAAUsJ,QAAQ,0BAI7BtC,UAAUuC,OAAO,mBACtBlJ,cAAgBF,KAAKE,cAG1BgJ,KADMpJ,SAASC,eAAe,mBAAqBC,KAAKhB,MAC7CqK,cAAc,MACpBxC,UAAUuC,OAAO,aAAcpJ,KAAKE,cACzCgJ,KAAKrC,UAAUuC,OAAO,cAAepJ,KAAKE,cAE1C6B,YAAW,IAAM/B,KAAKyD,YAAY,KAMtC6B,wBAGSnF,gBAAkBH,KAAKG,eAEtBL,SAASC,eAAe,mBAAqBC,KAAKhB,MACpD6H,UAAUuC,OAAO,SAAUpJ,KAAKG,2CAOhCmJ,QACA/H,gBAGA+H,cAAgB5D,UAAUrC,GAAGkG,eAAe,eAAgB,CACxDC,iBAAkB,CAAC,WAAY,sBAG9BlJ,SAAS+C,GAAGoG,WAAWH,SAE5B/H,YAAc,CAACvC,KAAMgB,KAAKhB,MAC1Bc,SAAS0B,cAAc,IAAIC,YAAY,kBAAmB,CAACC,OAAQH,oBAE9DmI,WAAW,YAClB,MAAO/H,OACLhD,aAAaiD,UAAUD,mCAQvB2H,QACA/H,gBAGA+H,cAAgB5D,UAAUrC,GAAGkG,eAAe,eAAgB,CACxDI,iBAAkB,CAAC,cAAe,wBAGjCrJ,SAAS+C,GAAGoG,WAAWH,SAE5B/H,YAAc,CAACvC,KAAMgB,KAAKhB,MAC1Bc,SAAS0B,cAAc,IAAIC,YAAY,kBAAmB,CAACC,OAAQH,oBAE9DmI,WAAW,YAClB,MAAO/H,OACLhD,aAAaiD,UAAUD,QAU/B+H,WAAWE,YAAQC,4DAAO,GACtBnL,KAAKoL,KAAK,CAAC,CACPC,WAAY,uBACZC,KAAM,CACF/K,OAAQe,KAAKf,OACb2K,OAAQA,OACRC,KAAMI,KAAKC,UAAUL,UAQjC3I,sBACSR,UAAY,IAAIE,MAAMuJ,eAGtBlK,OAAOuD,iBAAiB,SAAU4G,YAC/BC,KAAOrK,KAAKC,OAAOqK,gCAClB3J,MAAMuH,GAAMkC,MAAMG,QAAUF,KAAKG,MAAQH,KAAKtB,MAAS,EAAI,OAC3DpI,MAAMwH,IAAOiC,MAAMK,QAAUJ,KAAKK,KAAOL,KAAKrB,OAAU,EAAI,OAE5DtI,UAAUiK,cAAc3K,KAAKW,MAAOX,KAAKK,QAG1C+J,MAAMQ,UAAY5K,KAAKL,WAAaK,KAAKQ,MAAO,KAC5CqK,gBAAkB7K,KAAKU,UAAUoK,gBAAgB9K,KAAKQ,OAAO,MAC7DqK,gBAAgB1E,OAAS,EAAG,KACxB4E,MAAQF,gBAAgB,GAAGE,uBAC1BC,mBAAmBD,YAM5BE,WAAajL,KAAKU,UAAUwK,iBAAiBlL,KAAKS,kBAElDwK,WAAW9E,OAAS,EAAG,KACnBgF,YAAcF,WAAW,GAAGG,YAC3BC,iBAAiBF,YAAYG,cAQ9CjK,mBACQ2F,SACAE,SACAqE,OACAC,OAECxL,KAAKP,cAA6C,IAA7BO,KAAKP,aAAa0G,QAK5Ca,SAAW,IAAIpG,MAAM6K,eAAe,IAAM,GAAI,IAC9CvE,SAAW,IAAItG,MAAM8K,kBAAkB,CACnCtE,MAAO,QACPuE,aAAa,EACbC,QAAS,SAGR,MAAMC,WAAW7L,KAAKP,aACvB8L,OAAS,IAAI3K,MAAM2G,KAAKP,SAAUE,SAAS4E,SAC3CN,IAAMK,QAAQnJ,UAAY,CAACwF,EAAG,EAAGC,EAAG,EAAGC,EAAG,GAC1CmD,OAAO7I,SAASC,IAAI6I,IAAItD,EAAGsD,IAAIrD,EAAGqD,IAAIpD,GACtCmD,OAAOD,SAAWO,aACbzL,MAAMgE,IAAImH,aACV9K,cAAcsL,KAAKR,SAShCF,iBAAiBQ,aAET/F,MACAkG,QAFAC,MAAQnM,SAASC,eAAe,sBAAwBC,KAAKhB,MAK5DiN,SAEDA,MAAQnM,SAASoM,cAAc,QACzBC,GAAK,sBAAwBnM,KAAKhB,KACxCiN,MAAMG,UAAY,qBAClBH,MAAMI,UAAY,sMAKbxM,UAAUyM,YAAYL,OAGhBA,MAAM5C,cAAc,uBACtB7F,iBAAiB,SAAS,KAC/ByI,MAAMpF,UAAU0F,OAAO,cAK/BzG,MAAQmG,MAAM5C,cAAc,uBAC5B2C,QAAUC,MAAM5C,cAAc,yBAC9BvD,MAAM0G,YAAcX,QAAQ/F,OAAS,OACrCkG,QAAQK,UAAYR,QAAQG,SAAW,GAGvCC,MAAMpF,UAAUzC,IAAI,eAGfqI,iBAAiB,gBAAiB,CAACC,UAAWb,QAAQM,GAAIrG,MAAO+F,QAAQ/F,QAQlFkF,mBAAmBD,WACX4B,KAAO7M,SAASC,eAAe,qBAAuBC,KAAKhB,MAI1D2N,MA+BDA,KAAKtD,cAAc,6BAA+BrJ,KAAKhB,MAAM4N,MAAQ,GACrED,KAAKtD,cAAc,+BAAiCrJ,KAAKhB,MAAM4N,MAAQ,GACvED,KAAK9F,UAAUzC,IAAI,aA/BnBuI,KAAO7M,SAASoM,cAAc,QACzBC,GAAK,qBAAuBnM,KAAKhB,KACtC2N,KAAKP,UAAY,4BACjBO,KAAKN,UAAY,kLAG6BrM,KAAKhB,KAHlC,kEAIwCgB,KAAKhB,KAJ7C,8HAQ+BgB,KAAKhB,KARpC,6DASiCgB,KAAKhB,KATtC,wRAiBZa,UAAUyM,YAAYK,MAGfA,KAAKtD,cAAc,oBACrB7F,iBAAiB,SAAS,KAChCmJ,KAAK9F,UAAU0F,OAAO,cAU9BI,KAAKE,QAAQC,KAAO/B,MAAM7C,EAAE6E,QAAQ,GACpCJ,KAAKE,QAAQG,KAAOjC,MAAM5C,EAAE4E,QAAQ,GACpCJ,KAAKE,QAAQI,KAAOlC,MAAM3C,EAAE2E,QAAQ,GAG1BJ,KAAKtD,cAAc,kBACrB6D,QAAU,IAAMlN,KAAKmN,eAAeR,MAQhDQ,eAAeR,UACPS,WAAaT,KAAKtD,cAAc,6BAA+BrJ,KAAKhB,MACpEqO,aAAeV,KAAKtD,cAAc,+BAAiCrJ,KAAKhB,MACxE8G,MAAQsH,WAAWR,MAAMU,OACzBtB,QAAUqB,aAAaT,MAAMU,OAC7B5K,SAAW,CACXwF,EAAGqF,WAAWZ,KAAKE,QAAQC,MAC3B3E,EAAGoF,WAAWZ,KAAKE,QAAQG,MAC3B5E,EAAGmF,WAAWZ,KAAKE,QAAQI,OAG1BnH,MAMLpH,KAAKoL,KAAK,CAAC,CACPC,WAAY,wBACZC,KAAM,CACFmC,GAAI,EACJlN,OAAQe,KAAKf,OACbuO,QAAS,EACTC,KAAM,OACN3H,MAAOA,MACPkG,QAASA,QACTtJ,SAAUuH,KAAKC,UAAUxH,UACzBwG,KAAM,WAEV,GAAGwE,MAAMC,eAEL3G,SAAW,IAAIpG,MAAM6K,eAAe,IAAM,GAAI,IAC9CvE,SAAW,IAAItG,MAAM8K,kBAAkB,CACvCtE,MAAO,QACPuE,aAAa,EACbC,QAAS,KAETL,OAAS,IAAI3K,MAAM2G,KAAKP,SAAUE,iBACtCqE,OAAO7I,SAASC,IAAID,SAASwF,EAAGxF,SAASyF,EAAGzF,SAAS0F,GACrDmD,OAAOD,SAAW,CACda,GAAIwB,SAASxB,GACbrG,MAAOA,MACPkG,QAASA,QACTyB,KAAM,aAELrN,MAAMgE,IAAImH,aACV9K,cAAcsL,KAAKR,QAGxBoB,KAAK9F,UAAU0F,OAAO,UACtB5N,aAAaiP,gBAAgB,CACzBC,QAAS,6BACTJ,KAAM,YAGHE,YACRG,MAAMnP,aAAaiD,WA5ClBjD,aAAaoP,MAAM,QAAS,+BAgDjC,CAMHjN,KAAM,SAAS/B,aACPF,WAAWE"}