/**
 * GEAR Viewer - Main JavaScript module for 3D/AR/VR viewing.
 *
 * @module     mod_gear/viewer
 * @copyright  2026 Boban Blagojevic
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str"],(function(t,e,s,i){"use strict";class n{constructor(t){this.cmid=t.cmid,this.gearid=t.gearid,this.config=t.config||{},this.arEnabled=t.ar_enabled||!1,this.vrEnabled=t.vr_enabled||!1,this.container=document.getElementById(`gear-viewer-${this.cmid}`),this.canvas=document.getElementById(`gear-canvas-${this.cmid}`),this.isFullscreen=!1,this.isAutoRotating=!1,this.scene=null,this.camera=null,this.renderer=null,this.model=null,this.init()}async init(){try{await this.loadThreeJS(),this.setupScene(),this.setupControls(),this.setupEventListeners(),this.loadModels(),this.animate(),document.dispatchEvent(new CustomEvent("gear:scene:loaded",{detail:{cmid:this.cmid,gearid:this.gearid}}))}catch(t){s.exception(t)}}async loadThreeJS(){"undefined"==typeof THREE&&(await this.loadScript("https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"),await this.loadScript("https://cdn.jsdelivr.net/npm/three@0.150.0/examples/js/controls/OrbitControls.js"),await this.loadScript("https://cdn.jsdelivr.net/npm/three@0.150.0/examples/js/loaders/GLTFLoader.js"))}loadScript(t){return new Promise(((e,s)=>{const i=document.createElement("script");i.src=t,i.onload=e,i.onerror=s,document.head.appendChild(i)}))}setupScene(){this.scene=new THREE.Scene;const t=this.config.background||"#1a1a2e";this.scene.background=new THREE.Color(t);const e=this.container.clientWidth/this.container.clientHeight;this.camera=new THREE.PerspectiveCamera(75,e,.1,1e3);const s=this.config.camera?.position||[0,1.6,3];this.camera.position.set(s[0],s[1],s[2]),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0,alpha:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.outputEncoding=THREE.sRGBEncoding,this.renderer.xr.enabled=!0,this.setupLighting(),window.addEventListener("resize",(()=>this.onResize()))}setupLighting(){const t=this.config.lighting||"studio",e=new THREE.AmbientLight(16777215,.5);switch(this.scene.add(e),t){case"studio":const t=new THREE.DirectionalLight(16777215,1);t.position.set(5,5,5),this.scene.add(t);const e=new THREE.DirectionalLight(16777215,.5);e.position.set(-5,0,5),this.scene.add(e);const s=new THREE.DirectionalLight(16777215,.3);s.position.set(0,5,-5),this.scene.add(s);break;case"outdoor":const i=new THREE.DirectionalLight(16777164,1.2);i.position.set(10,10,5),this.scene.add(i);const n=new THREE.HemisphereLight(8900331,4021340,.6);this.scene.add(n);break;case"dark":const a=new THREE.SpotLight(16777215,.8);a.position.set(0,5,0),this.scene.add(a)}}setupControls(){this.controls=new THREE.OrbitControls(this.camera,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=.5,this.controls.maxDistance=50,this.controls.maxPolarAngle=Math.PI}setupEventListeners(){const t=document.getElementById(`gear-fullscreen-${this.cmid}`);t&&t.addEventListener("click",(()=>this.toggleFullscreen()));const e=document.getElementById(`gear-autorotate-${this.cmid}`);e&&e.addEventListener("click",(()=>this.toggleAutoRotate()));const s=document.getElementById(`gear-ar-${this.cmid}`);s&&this.arEnabled&&this.setupARButton(s);const i=document.getElementById(`gear-vr-${this.cmid}`);i&&this.vrEnabled&&this.setupVRButton(i)}async setupARButton(t){if("xr"in navigator){await navigator.xr.isSessionSupported("immersive-ar")?t.addEventListener("click",(()=>this.startARSession())):(t.disabled=!0,t.title=await i.get_string("arnotsupported","mod_gear"))}else t.disabled=!0}async setupVRButton(t){if("xr"in navigator){await navigator.xr.isSessionSupported("immersive-vr")?t.addEventListener("click",(()=>this.startVRSession())):(t.disabled=!0,t.title=await i.get_string("webxrnotsupported","mod_gear"))}else t.disabled=!0}async loadModels(){try{const t=await e.call([{methodname:"mod_gear_get_models",args:{gearid:this.gearid}}])[0];if(t.models&&t.models.length>0){const e=new THREE.GLTFLoader;for(const s of t.models){const t=await new Promise(((t,i)=>{e.load(s.url,t,void 0,i)}));if(this.model=t.scene,s.position){const t=JSON.parse(s.position);this.model.position.set(t.x||0,t.y||0,t.z||0)}if(s.rotation){const t=JSON.parse(s.rotation);this.model.rotation.set(t.x||0,t.y||0,t.z||0)}s.scale&&this.model.scale.setScalar(s.scale),this.scene.add(this.model),this.centerCameraOnModel(this.model)}}this.container.classList.add("loaded")}catch(t){this.addPlaceholderModel(),this.container.classList.add("loaded")}}addPlaceholderModel(){const t=new THREE.BoxGeometry(1,1,1),e=new THREE.MeshStandardMaterial({color:4886745,metalness:.3,roughness:.4});this.model=new THREE.Mesh(t,e),this.scene.add(this.model)}centerCameraOnModel(t){const e=(new THREE.Box3).setFromObject(t),s=e.getCenter(new THREE.Vector3),i=e.getSize(new THREE.Vector3),n=Math.max(i.x,i.y,i.z),a=this.camera.fov*(Math.PI/180);let o=Math.abs(n/2/Math.tan(a/2));o*=1.5,this.camera.position.set(s.x,s.y,s.z+o),this.controls.target.copy(s),this.controls.update()}animate(){this.renderer.setAnimationLoop((()=>{this.isAutoRotating&&this.model&&(this.model.rotation.y+=.005),this.controls.update(),this.renderer.render(this.scene,this.camera)}))}onResize(){const t=this.container.clientWidth,e=this.container.clientHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}toggleFullscreen(){this.container.closest(".gear-viewer-container").classList.toggle("fullscreen"),this.isFullscreen=!this.isFullscreen;const t=document.getElementById(`gear-fullscreen-${this.cmid}`).querySelector("i");t.classList.toggle("fa-expand",!this.isFullscreen),t.classList.toggle("fa-compress",this.isFullscreen),setTimeout((()=>this.onResize()),100)}toggleAutoRotate(){this.isAutoRotating=!this.isAutoRotating;document.getElementById(`gear-autorotate-${this.cmid}`).classList.toggle("active",this.isAutoRotating)}async startARSession(){try{const t=await navigator.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","local-floor"]});this.renderer.xr.setSession(t),document.dispatchEvent(new CustomEvent("gear:ar:started",{detail:{cmid:this.cmid}})),this.trackEvent("ar_start")}catch(t){s.exception(t)}}async startVRSession(){try{const t=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]});this.renderer.xr.setSession(t),document.dispatchEvent(new CustomEvent("gear:vr:started",{detail:{cmid:this.cmid}})),this.trackEvent("vr_start")}catch(t){s.exception(t)}}trackEvent(t,s={}){e.call([{methodname:"mod_gear_track_event",args:{gearid:this.gearid,action:t,data:JSON.stringify(s)}}])}}return{init:function(t){new n(t)}}}));