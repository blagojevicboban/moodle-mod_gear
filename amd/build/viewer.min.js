define(["jquery","core/ajax","core/notification","core/str"],function(t,a,g,e){class s{constructor(t){this.cmid=t.cmid,this.gearid=t.gearid,this.config=t.config||{},this.config.hotspots&&void 0!==this.config.hotspots.enabled?this.hotspotsEnabled=!!this.config.hotspots.enabled:this.hotspotsEnabled=!0,this.hotspotsEditable=this.config.hotspots&&!!this.config.hotspots.edit||!1,this.arEnabled=t.ar_enabled||!1,this.vrEnabled=t.vr_enabled||!1,this.modelsData=t.models||[],this.hotspotsData=t.hotspots||[],this.canManage=t.canmanage||!1,this.container=document.getElementById("gear-viewer-"+this.cmid),this.canvas=document.getElementById("gear-canvas-"+this.cmid),this.isFullscreen=!1,this.isAutoRotating=!1,this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.model=null,this.hotspotMeshes=[],this.raycaster=null,this.mouse=new THREE.Vector2,this.audioListener=null,this.init()}async init(){try{await this.loadThreeJS(),this.setupScene(),this.setupControls(),this.setupRaycaster(),this.setupEventListeners(),this.loadModels(),this.hotspotsEnabled&&this.loadHotspots(),this.animate();var t={cmid:this.cmid,gearid:this.gearid};document.dispatchEvent(new CustomEvent("gear:scene:loaded",{detail:t}))}catch(t){g.exception(t)}}async loadThreeJS(){if("undefined"==typeof THREE&&await new Promise(t=>setTimeout(t,500)),"undefined"==typeof THREE)throw new Error("Three.js not loaded. Please check view.php.")}setupScene(){var t;this.scene=new THREE.Scene,t=this.config.background||"#1a1a2e",this.scene.background=new THREE.Color(t),t=this.container.clientWidth/this.container.clientHeight,this.camera=new THREE.PerspectiveCamera(75,t,.1,1e3),t=this.config.camera?.position||[0,1.6,3],this.camera.position.set(t[0],t[1],t[2]),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0,alpha:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.outputEncoding=THREE.sRGBEncoding,this.renderer.xr.enabled=!0,this.audioListener=new THREE.AudioListener,this.camera.add(this.audioListener),this.setupLighting(),window.addEventListener("resize",()=>this.onResize())}setupLighting(){var t,e=this.config.lighting||"studio",i=new THREE.AmbientLight(16777215,.5);switch(this.scene.add(i),e){case"studio":(t=new THREE.DirectionalLight(16777215,1)).position.set(5,5,5),this.scene.add(t),(t=new THREE.DirectionalLight(16777215,.5)).position.set(-5,0,5),this.scene.add(t),(t=new THREE.DirectionalLight(16777215,.3)).position.set(0,5,-5),this.scene.add(t);break;case"outdoor":(t=new THREE.DirectionalLight(16777164,1.2)).position.set(10,10,5),this.scene.add(t),t=new THREE.HemisphereLight(8900331,4021340,.6),this.scene.add(t);break;case"dark":(t=new THREE.SpotLight(16777215,.8)).position.set(0,5,0),this.scene.add(t)}}setupControls(){this.controls=new THREE.OrbitControls(this.camera,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=.5,this.controls.maxDistance=50,this.controls.maxPolarAngle=Math.PI}setupEventListeners(){var t=document.getElementById("gear-fullscreen-"+this.cmid);t&&t.addEventListener("click",()=>this.toggleFullscreen()),(t=document.getElementById("gear-autorotate-"+this.cmid))&&t.addEventListener("click",()=>this.toggleAutoRotate()),(t=document.getElementById("gear-ar-"+this.cmid))&&this.arEnabled&&this.setupARButton(t),(t=document.getElementById("gear-vr-"+this.cmid))&&this.vrEnabled&&this.setupVRButton(t),this.setupLeaderboardButton()}setupLeaderboardButton(){var t=document.createElement("button");t.className="btn btn-secondary gear-control-btn gear-leaderboard-btn",t.title="Leaderboard",t.innerHTML='<i class="fa fa-trophy"></i>',t.style.position="absolute",t.style.top="10px",t.style.right="60px",t.style.zIndex="1000",t.addEventListener("click",()=>this.showLeaderboard()),this.container.appendChild(t)}showLeaderboard(){var t=document.getElementById("gear-leaderboard-modal-"+this.cmid),e=((t=t||this.createLeaderboardModal()).classList.add("active"),t.querySelector(".gear-leaderboard-content"));e.innerHTML='<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</div>',a.call([{methodname:"mod_gear_get_leaderboard",args:{gearid:this.gearid,limit:10}}])[0].then(t=>{this.renderLeaderboard(e,t)}).catch(g.exception)}createLeaderboardModal(){var t=document.createElement("div"),e=(t.id="gear-leaderboard-modal-"+this.cmid,t.className="gear-modal",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.background="rgba(0,0,0,0.8)",t.style.display="none",t.style.zIndex="2000",t.style.justifyContent="center",t.style.alignItems="center",t.innerHTML=`
                <div class="gear-modal-dialog" style="background:white; padding:20px; border-radius:8px; max-width:500px; width:90%; position:relative;">
                    <button class="close" style="position:absolute; top:10px; right:10px;">&times;</button>
                    <h3><i class="fa fa-trophy text-warning"></i> Leaderboard</h3>
                    <div class="gear-leaderboard-content"></div>
                </div>
            `,t.querySelector(".close").addEventListener("click",()=>{t.classList.remove("active"),t.style.display="none"}),document.createElement("style"));return e.textContent=`#gear-leaderboard-modal-${this.cmid}.active { display: flex !important; }`,document.head.appendChild(e),this.container.appendChild(t),t}renderLeaderboard(t,e){var s;0===e.length?t.innerHTML='<p class="text-muted text-center">No scores yet. Be the first!</p>':(s='<table class="table table-striped"><thead><tr><th>#</th><th>User</th><th>Score</th></tr></thead><tbody>',e.forEach((t,e)=>{var i="";0===e?i="ðŸ¥‡":1===e?i="ðŸ¥ˆ":2===e&&(i="ðŸ¥‰"),s+=`<tr>
                    <td>${e+1} ${i}</td>
                    <td>${t.fullname}</td>
                    <td><strong>${t.score}</strong></td>
                </tr>`}),s+="</tbody></table>",t.innerHTML=s)}async setupARButton(t){"xr"in navigator?await navigator.xr.isSessionSupported("immersive-ar")?t.addEventListener("click",()=>this.startARSession()):(t.disabled=!0,t.title=await e.get_string("arnotsupported","mod_gear")):t.disabled=!0}async setupVRButton(t){"xr"in navigator?await navigator.xr.isSessionSupported("immersive-vr")?t.addEventListener("click",()=>this.startVRSession()):(t.disabled=!0,t.title=await e.get_string("webxrnotsupported","mod_gear")):t.disabled=!0}async loadModels(){var s,t;try{if(this.modelsData&&0<this.modelsData.length){s=new THREE.GLTFLoader;for(let i of this.modelsData)t=await new Promise((t,e)=>{s.load(i.url,t,void 0,e)}),this.model=t.scene,this.model.scale.setScalar(1),this.scene.add(this.model),this.centerCameraOnModel(this.model)}else this.addPlaceholderModel();this.container.classList.add("loaded")}catch(t){window.console.error("GEAR: Error loading model:",t),this.addPlaceholderModel(),this.container.classList.add("loaded")}}addPlaceholderModel(){var t=new THREE.BoxGeometry(1,1,1),e=new THREE.MeshStandardMaterial({color:4886745,metalness:.3,roughness:.4});this.model=new THREE.Mesh(t,e),this.scene.add(this.model)}centerCameraOnModel(t){var t=(new THREE.Box3).setFromObject(t),e=t.getCenter(new THREE.Vector3),t=t.getSize(new THREE.Vector3),t=Math.max(t.x,t.y,t.z),i=this.camera.fov*(Math.PI/180),t=Math.abs(t/2/Math.tan(i/2));this.camera.position.set(e.x,e.y,e.z+(t*=1.5)),this.controls.target.copy(e),this.controls.update()}animate(){this.renderer.setAnimationLoop(()=>{this.isAutoRotating&&this.model&&(this.model.rotation.y+=.005),this.controls.update(),this.renderer.render(this.scene,this.camera)})}onResize(){var t=this.container.clientWidth,e=this.container.clientHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}toggleFullscreen(){var t;this.container.closest(".gear-viewer-container").classList.toggle("fullscreen"),this.isFullscreen=!this.isFullscreen,(t=document.getElementById("gear-fullscreen-"+this.cmid).querySelector("i")).classList.toggle("fa-expand",!this.isFullscreen),t.classList.toggle("fa-compress",this.isFullscreen),setTimeout(()=>this.onResize(),100)}toggleAutoRotate(){this.isAutoRotating=!this.isAutoRotating,document.getElementById("gear-autorotate-"+this.cmid).classList.toggle("active",this.isAutoRotating)}async startARSession(){var t,e;try{t=await navigator.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","local-floor"]}),this.renderer.xr.setSession(t),e={cmid:this.cmid},document.dispatchEvent(new CustomEvent("gear:ar:started",{detail:e})),this.trackEvent("ar_start")}catch(t){g.exception(t)}}async startVRSession(){var t,e;try{t=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}),this.renderer.xr.setSession(t),e={cmid:this.cmid},document.dispatchEvent(new CustomEvent("gear:vr:started",{detail:e})),this.trackEvent("vr_start")}catch(t){g.exception(t)}}trackEvent(t,e={}){a.call([{methodname:"mod_gear_track_event",args:{gearid:this.gearid,action:t,data:JSON.stringify(e)}}])}setupRaycaster(){this.raycaster=new THREE.Raycaster,this.canvas.addEventListener("click",t=>{var e=this.canvas.getBoundingClientRect();if(this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-(t.clientY-e.top)/e.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera),t.shiftKey&&this.canManage&&this.model&&this.hotspotsEnabled){e=this.raycaster.intersectObject(this.model,!0);if(0<e.length)return t=e[0].point,void this.showAddHotspotForm(t)}e=this.raycaster.intersectObjects(this.hotspotMeshes);0<e.length&&(t=e[0].object,this.showHotspotPopup(t.userData))})}loadHotspots(){var t,e,i;if(this.hotspotsData&&0!==this.hotspotsData.length){t=new THREE.SphereGeometry(.08,16,16),e=new THREE.MeshBasicMaterial({color:6514417,transparent:!0,opacity:.9});for(var s of this.hotspotsData){if(i=new THREE.Mesh(t,e.clone()),a=s.position||{x:0,y:0,z:0},i.position.set(a.x,a.y,a.z),"audio"===(i.userData=s).type&&s.config){var a="string"==typeof s.config?JSON.parse(s.config):s.config;if(a.audioUrl)try{var o=new THREE.PositionalAudio(this.audioListener);(new THREE.AudioLoader).load(a.audioUrl,t=>{o.setBuffer(t),o.setRefDistance(1),o.setRolloffFactor(1),o.setLoop(!0),i.add(o),i.userData.sound=o}),i.material.color.setHex(1096065)}catch(t){window.console.warn("GEAR: Failed to load audio",t)}}this.scene.add(i),this.hotspotMeshes.push(i)}}}showHotspotPopup(e){var t,i,s,a,o,r=document.getElementById("gear-hotspot-popup-"+this.cmid);r||((r=document.createElement("div")).id="gear-hotspot-popup-"+this.cmid,r.className="gear-hotspot-popup",r.innerHTML='<div class="gear-hotspot-popup-inner"><button class="gear-hotspot-close" aria-label="Close">&times;</button><h4 class="gear-hotspot-title"></h4><div class="gear-hotspot-content"></div></div>',this.container.appendChild(r),r.querySelector(".gear-hotspot-close").addEventListener("click",()=>{r.classList.remove("active")})),i=r.querySelector(".gear-hotspot-title"),t=r.querySelector(".gear-hotspot-content"),i.textContent=e.title||"Info",t.innerHTML=e.content||"","quiz"===e.type?this.renderQuizInPopup(r,e):"audio"===e.type&&e.sound&&((i=document.createElement("div")).className="gear-audio-controls mt-2",s=e.sound.isPlaying?"Pause Audio":"Play Audio",o=e.sound.isPlaying?"fa-pause":"fa-play",i.innerHTML=`
                    <button class="btn btn-sm btn-info gear-audio-toggle">
                        <i class="fa ${o}"></i> ${s}
                    </button>
                    <div class="small text-muted mt-1"><i class="fa fa-volume-up"></i> Spatial Audio</div>
                `,(a=i.querySelector(".gear-audio-toggle")).addEventListener("click",()=>{e.sound.isPlaying?(e.sound.pause(),a.innerHTML='<i class="fa fa-play"></i> Play Audio'):(e.sound.play(),a.innerHTML='<i class="fa fa-pause"></i> Pause Audio')}),t.appendChild(i)),this.canManage&&this.hotspotsEditable&&((o=document.createElement("button")).className="btn btn-secondary gear-edit-hotspot",o.textContent="Edit",o.style.marginLeft="0.5rem",o.addEventListener("click",()=>{var t=e.position||{x:0,y:0,z:0};this.showAddHotspotForm({x:t.x,y:t.y,z:t.z},e),r.classList.remove("active")}),(r.querySelector(".gear-hotspot-title")||r.querySelector(".gear-hotspot-popup-inner")).appendChild(o)),r.classList.add("active"),"function"==typeof this.trackInteraction&&this.trackInteraction("hotspot_click",{hotspotId:e.id,title:e.title})}showAddHotspotForm(t,e){var i,s,a,o,r,n=document.getElementById("gear-hotspot-form-"+this.cmid);n?(n.querySelector("#gear-hotspot-input-title-"+this.cmid).value="",n.querySelector("#gear-hotspot-input-content-"+this.cmid).value="",n.removeAttribute("data-hotspot-id"),n.classList.add("active")):((n=document.createElement("div")).id="gear-hotspot-form-"+this.cmid,n.className="gear-hotspot-popup active",n.innerHTML='<div class="gear-hotspot-popup-inner gear-hotspot-form-inner"><h4 class="gear-hotspot-title">Add Hotspot</h4><div class="gear-form-group"><label for="gear-hotspot-input-title-'+this.cmid+'">Title</label><input type="text" id="gear-hotspot-input-title-'+this.cmid+'" class="form-control" placeholder="Enter title"></div><div class="gear-form-group"><label for="gear-hotspot-input-type-'+this.cmid+'">Type</label><div class="d-flex"><select id="gear-hotspot-input-type-'+this.cmid+'" class="form-control mr-2"><option value="info">Info</option><option value="quiz">Quiz</option><option value="audio">Audio</option></select><button type="button" class="btn btn-info gear-ai-btn" title="AI Assist">âœ¨ AI Assist</button></div></div><div id="gear-hotspot-quiz-fields-'+this.cmid+'" style="display:none;"><div class="gear-form-group"><label for="gear-hotspot-input-options-'+this.cmid+'">Options (comma separated)</label><input type="text" id="gear-hotspot-input-options-'+this.cmid+'" class="form-control" placeholder="Option A, Option B, Option C"></div><div class="gear-form-group"><label for="gear-hotspot-input-correct-'+this.cmid+'">Correct Answer (Index 0-N)</label><input type="number" id="gear-hotspot-input-correct-'+this.cmid+'" class="form-control" value="0" min="0"></div><div class="gear-form-group"><label for="gear-hotspot-input-points-'+this.cmid+'">Points</label><input type="number" id="gear-hotspot-input-points-'+this.cmid+'" class="form-control" value="10" min="1"></div></div><div id="gear-hotspot-audio-fields-'+this.cmid+'" style="display:none;"><div class="gear-form-group"><label for="gear-hotspot-input-audiourl-'+this.cmid+'">Audio URL (MP3/WAV)</label><input type="text" id="gear-hotspot-input-audiourl-'+this.cmid+'" class="form-control" placeholder="https://example.com/audio.mp3"></div></div><div class="gear-form-group"><label for="gear-hotspot-input-content-'+this.cmid+'">Content</label><textarea id="gear-hotspot-input-content-'+this.cmid+'" class="form-control" rows="3" placeholder="Enter content"></textarea></div><div class="gear-form-actions"><button type="button" class="btn btn-secondary gear-cancel-btn">Cancel</button><button type="button" class="btn btn-primary gear-save-btn">Save</button></div></div>',this.container.appendChild(n),o=n.querySelector("#gear-hotspot-input-type-"+this.cmid),i=n.querySelector("#gear-hotspot-quiz-fields-"+this.cmid),s=n.querySelector("#gear-hotspot-audio-fields-"+this.cmid),o.addEventListener("change",()=>{i.style.display="quiz"===o.value?"block":"none",s.style.display="audio"===o.value?"block":"none"}),(a=n.querySelector(".gear-ai-btn")).addEventListener("click",()=>{var i=o.value,s=window.prompt("What should this hotspot be about?","");s&&(a.disabled=!0,a.textContent="Generating...",this.generateContent(s,i).then(t=>{if(a.disabled=!1,a.textContent="âœ¨ AI Assist","quiz"===i)try{var e=JSON.parse(t);n.querySelector("#gear-hotspot-input-title-"+this.cmid).value=e.question||"",n.querySelector("#gear-hotspot-input-options-"+this.cmid).value=e.options?e.options.join(", "):"",n.querySelector("#gear-hotspot-input-correct-"+this.cmid).value=e.correct||0}catch(t){g.alert("Error","Failed to parse AI response")}else"info"===i&&(n.querySelector("#gear-hotspot-input-title-"+this.cmid).value=s,n.querySelector("#gear-hotspot-input-content-"+this.cmid).value=t)}).catch(t=>{a.disabled=!1,a.textContent="âœ¨ AI Assist",g.alert("AI Error",t.message||"Generation failed")}))}),n.querySelector(".gear-cancel-btn").addEventListener("click",()=>{n.classList.remove("active")})),e?(n.querySelector("#gear-hotspot-input-title-"+this.cmid).value=e.title||"",n.querySelector("#gear-hotspot-input-content-"+this.cmid).value=e.content||"",n.dataset.hotspotId=e.id,(o=n.querySelector("#gear-hotspot-input-type-"+this.cmid)).value=e.type||"info",o.dispatchEvent(new Event("change")),"quiz"===e.type&&e.config?(r="string"==typeof e.config?JSON.parse(e.config):e.config,n.querySelector("#gear-hotspot-input-options-"+this.cmid).value=r.options?r.options.join(", "):"",n.querySelector("#gear-hotspot-input-correct-"+this.cmid).value=r.correctAnswer||0,n.querySelector("#gear-hotspot-input-points-"+this.cmid).value=r.points||10):"audio"===e.type&&e.config&&(r="string"==typeof e.config?JSON.parse(e.config):e.config,n.querySelector("#gear-hotspot-input-audiourl-"+this.cmid).value=r.audioUrl||""),n.dataset.posX=(r=e.position||t).x.toFixed(3),n.dataset.posY=r.y.toFixed(3),n.dataset.posZ=r.z.toFixed(3)):(n.dataset.posX=t.x.toFixed(3),n.dataset.posY=t.y.toFixed(3),n.dataset.posZ=t.z.toFixed(3)),n.querySelector(".gear-save-btn").onclick=()=>this.saveNewHotspot(n)}saveNewHotspot(n){var d,t=n.querySelector("#gear-hotspot-input-title-"+this.cmid),e=n.querySelector("#gear-hotspot-input-content-"+this.cmid),c=t.value.trim(),l=e.value.trim(),h={x:parseFloat(n.dataset.posX),y:parseFloat(n.dataset.posY),z:parseFloat(n.dataset.posZ)},p=n.querySelector("#gear-hotspot-input-type-"+this.cmid).value,u={};if("quiz"===p){var t=n.querySelector("#gear-hotspot-input-options-"+this.cmid).value,e=n.querySelector("#gear-hotspot-input-correct-"+this.cmid).value,i=n.querySelector("#gear-hotspot-input-points-"+this.cmid).value;if(u.options=t.split(",").map(t=>t.trim()).filter(t=>0<t.length),u.correctAnswer=parseInt(e,10),u.points=parseInt(i,10),u.options.length<2)return void g.alert("Error","Please provide at least 2 options")}c?(d=n.dataset.hotspotId?parseInt(n.dataset.hotspotId,10):0,a.call([{methodname:"mod_gear_save_hotspot",args:{id:d,gearid:this.gearid,modelid:0,type:p,title:c,content:l,position:JSON.stringify(h),icon:"quiz"===p?"question":"info",config:JSON.stringify(u)}}])[0].then(t=>{var e=new THREE.SphereGeometry(.08,16,16),i=new THREE.MeshBasicMaterial({color:6514417,transparent:!0,opacity:.9});if(d&&0<d){for(var s=!1,a=0;a<this.hotspotMeshes.length;a++){var o=this.hotspotMeshes[a];if(o.userData&&o.userData.id==d){o.userData.title=c,o.userData.content=l,o.userData.type=p,o.userData.icon="quiz"===p?"question":"info",o.userData.config=JSON.stringify(u),o.position.set(h.x,h.y,h.z),s=!0;break}}s||((r=new THREE.Mesh(e,i)).position.set(h.x,h.y,h.z),r.userData={id:t.id,title:c,content:l,type:p,icon:"quiz"===p?"question":"info",config:JSON.stringify(u)},this.scene.add(r),this.hotspotMeshes.push(r))}else{var r=new THREE.Mesh(e,i);r.position.set(h.x,h.y,h.z),r.userData={id:t.id,title:c,content:l,type:p,icon:"quiz"===p?"question":"info",config:JSON.stringify(u)},this.scene.add(r),this.hotspotMeshes.push(r)}return n.classList.remove("active"),g.addNotification({message:"Hotspot saved successfully",type:"success"}),t}).catch(g.exception)):g.alert("Error","Please enter a title")}renderQuizInPopup(e,i){var s,t=e.querySelector(".gear-hotspot-content"),a="string"==typeof i.config?JSON.parse(i.config):i.config;a&&a.options?(s='<div class="gear-quiz-container">',s+='<form id="gear-quiz-form-'+i.id+'">',a.options.forEach((t,e)=>{s=(s=(s+='<div class="form-check">')+'<input class="form-check-input" type="radio" name="gear-quiz-option" id="q-opt-'+i.id+"-"+e+'" value="'+e+'">')+'<label class="form-check-label" for="q-opt-'+i.id+"-"+e+'">'+t+"</label></div>"}),s+='<button type="button" class="btn btn-primary btn-sm mt-2 gear-quiz-submit">Submit</button><div class="gear-quiz-feedback mt-2"></div></form></div>',t.innerHTML+=s,e.querySelector(".gear-quiz-submit").addEventListener("click",()=>{var t=e.querySelector('input[name="gear-quiz-option"]:checked');t?this.submitQuizAnswer(i,t.value,e):g.alert("Warning","Please select an answer")})):t.innerHTML+='<p class="text-danger">Invalid quiz configuration</p>'}submitQuizAnswer(t,e,s){a.call([{methodname:"mod_gear_submit_quiz",args:{gearid:this.gearid,hotspotid:t.id,answer:e}}])[0].then(t=>{var e=s.querySelector(".gear-quiz-feedback"),i=s.querySelector(".gear-quiz-submit");t.correct?e.innerHTML='<span class="badge badge-success">Correct!</span> +'+t.score+" pts":e.innerHTML='<span class="badge badge-danger">Incorrect</span>',i.disabled=!0}).catch(g.exception)}generateContent(t,e){return a.call([{methodname:"mod_gear_generate_content",args:{gearid:this.gearid,prompt:t,type:e}}])[0].then(t=>t.success?t.content:Promise.reject("Generation failed"))}}class o{constructor(t){this.viewer=t,this.interval=null,this.avatars={},this.lastPosition=null,this.lastRotation=null}start(){this.interval=setInterval(()=>this.sync(),2e3),this.sync()}stop(){this.interval&&(clearInterval(this.interval),this.interval=null)}sync(){var t,e;this.viewer.camera&&(t=this.viewer.camera.position,e=this.viewer.camera.rotation,t={x:t.x,y:t.y,z:t.z},e={x:e.x,y:e.y,z:e.z},a.call([{methodname:"mod_gear_sync_session",args:{gearid:this.viewer.gearid,position:JSON.stringify(t),rotation:JSON.stringify(e)}}])[0].then(t=>{this.updateAvatars(t)}).catch(t=>{window.console.warn("Sync error",t)}))}updateAvatars(t){var e=new Set;t.forEach(t=>{e.add(t.userid),this.avatars[t.userid]||this.createAvatar(t),this.updateAvatarState(t)}),Object.keys(this.avatars).forEach(t=>{e.has(parseInt(t))||this.removeAvatar(t)})}createAvatar(t){var e=new THREE.Group,i=new THREE.SphereGeometry(.3,16,16),s="#"+Math.floor(16777215*Math.random()).toString(16),s=new THREE.MeshBasicMaterial({color:s}),i=new THREE.Mesh(i,s);e.add(i),this.viewer.scene.add(e),this.avatars[t.userid]={mesh:e}}updateAvatarState(t){var e=this.avatars[t.userid];if(e){if(t.position)try{var i="string"==typeof t.position?JSON.parse(t.position):t.position;e.mesh.position.set(i.x,i.y,i.z)}catch(t){}if(t.rotation)try{var s="string"==typeof t.rotation?JSON.parse(t.rotation):t.rotation;e.mesh.rotation.set(s.x,s.y,s.z)}catch(t){}}}removeAvatar(t){var e=this.avatars[t];e&&e.mesh&&this.viewer.scene.remove(e.mesh),delete this.avatars[t]}}return{init:function(e){var t=new s(e),i=new o(t);document.addEventListener("gear:scene:loaded",t=>{t.detail.cmid==e.cmid&&i.start()})}}});
//# sourceMappingURL=viewer.min.js.map