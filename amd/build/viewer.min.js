/**
 * GEAR Viewer - Main JavaScript module for 3D/AR/VR viewing.
 *
 * @module     mod_gear/viewer
 * @copyright  2026 Boban Blagojevic
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_gear/viewer",["jquery","core/ajax","core/notification","core/str"],(function($,Ajax,Notification,Str){class GearViewer{constructor(options){this.cmid=options.cmid,this.gearid=options.gearid,this.config=options.config||{},this.arEnabled=options.ar_enabled||!1,this.vrEnabled=options.vr_enabled||!1,this.modelsData=options.models||[],this.hotspotsData=options.hotspots||[],this.canManage=options.canmanage||!1,this.container=document.getElementById("gear-viewer-"+this.cmid),this.canvas=document.getElementById("gear-canvas-"+this.cmid),this.isFullscreen=!1,this.isAutoRotating=!1,this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.model=null,this.hotspotMeshes=[],this.raycaster=null,this.mouse=new THREE.Vector2,this.init()}async init(){try{await this.loadThreeJS(),this.setupScene(),this.setupControls(),this.setupRaycaster(),this.setupEventListeners(),this.loadModels(),this.loadHotspots(),this.animate();var eventDetail={cmid:this.cmid,gearid:this.gearid};document.dispatchEvent(new CustomEvent("gear:scene:loaded",{detail:eventDetail}))}catch(error){Notification.exception(error)}}async loadThreeJS(){if("undefined"==typeof THREE&&await new Promise((resolve=>setTimeout(resolve,500))),"undefined"==typeof THREE)throw new Error("Three.js not loaded. Please check view.php.")}setupScene(){var _this$config$camera,bgColor,aspect,camPos;this.scene=new THREE.Scene,bgColor=this.config.background||"#1a1a2e",this.scene.background=new THREE.Color(bgColor),aspect=this.container.clientWidth/this.container.clientHeight,this.camera=new THREE.PerspectiveCamera(75,aspect,.1,1e3),camPos=(null===(_this$config$camera=this.config.camera)||void 0===_this$config$camera?void 0:_this$config$camera.position)||[0,1.6,3],this.camera.position.set(camPos[0],camPos[1],camPos[2]),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0,alpha:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.outputEncoding=THREE.sRGBEncoding,this.renderer.xr.enabled=!0,this.setupLighting(),window.addEventListener("resize",(()=>this.onResize()))}setupLighting(){var ambient,keyLight,fillLight,rimLight,sunLight,skyLight,spotLight,preset=this.config.lighting||"studio";switch(ambient=new THREE.AmbientLight(16777215,.5),this.scene.add(ambient),preset){case"studio":(keyLight=new THREE.DirectionalLight(16777215,1)).position.set(5,5,5),this.scene.add(keyLight),(fillLight=new THREE.DirectionalLight(16777215,.5)).position.set(-5,0,5),this.scene.add(fillLight),(rimLight=new THREE.DirectionalLight(16777215,.3)).position.set(0,5,-5),this.scene.add(rimLight);break;case"outdoor":(sunLight=new THREE.DirectionalLight(16777164,1.2)).position.set(10,10,5),this.scene.add(sunLight),skyLight=new THREE.HemisphereLight(8900331,4021340,.6),this.scene.add(skyLight);break;case"dark":(spotLight=new THREE.SpotLight(16777215,.8)).position.set(0,5,0),this.scene.add(spotLight)}}setupControls(){this.controls=new THREE.OrbitControls(this.camera,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=.5,this.controls.maxDistance=50,this.controls.maxPolarAngle=Math.PI}setupEventListeners(){var fullscreenBtn,autorotateBtn,arBtn,vrBtn;(fullscreenBtn=document.getElementById("gear-fullscreen-"+this.cmid))&&fullscreenBtn.addEventListener("click",(()=>this.toggleFullscreen())),(autorotateBtn=document.getElementById("gear-autorotate-"+this.cmid))&&autorotateBtn.addEventListener("click",(()=>this.toggleAutoRotate())),(arBtn=document.getElementById("gear-ar-"+this.cmid))&&this.arEnabled&&this.setupARButton(arBtn),(vrBtn=document.getElementById("gear-vr-"+this.cmid))&&this.vrEnabled&&this.setupVRButton(vrBtn)}async setupARButton(button){"xr"in navigator?await navigator.xr.isSessionSupported("immersive-ar")?button.addEventListener("click",(()=>this.startARSession())):(button.disabled=!0,button.title=await Str.get_string("arnotsupported","mod_gear")):button.disabled=!0}async setupVRButton(button){"xr"in navigator?await navigator.xr.isSessionSupported("immersive-vr")?button.addEventListener("click",(()=>this.startVRSession())):(button.disabled=!0,button.title=await Str.get_string("webxrnotsupported","mod_gear")):button.disabled=!0}async loadModels(){var loader,gltf;try{if(this.modelsData&&this.modelsData.length>0){loader=new THREE.GLTFLoader;for(const modelData of this.modelsData)gltf=await new Promise(((resolve,reject)=>{loader.load(modelData.url,resolve,void 0,reject)})),this.model=gltf.scene,this.model.scale.setScalar(1),this.scene.add(this.model),this.centerCameraOnModel(this.model);this.container.classList.add("loaded")}else this.addPlaceholderModel(),this.container.classList.add("loaded")}catch(error){window.console.error("GEAR: Error loading model:",error),this.addPlaceholderModel(),this.container.classList.add("loaded")}}addPlaceholderModel(){var geometry=new THREE.BoxGeometry(1,1,1),material=new THREE.MeshStandardMaterial({color:4886745,metalness:.3,roughness:.4});this.model=new THREE.Mesh(geometry,material),this.scene.add(this.model)}centerCameraOnModel(model){var box=(new THREE.Box3).setFromObject(model),center=box.getCenter(new THREE.Vector3),size=box.getSize(new THREE.Vector3),maxDim=Math.max(size.x,size.y,size.z),fov=this.camera.fov*(Math.PI/180),cameraZ=Math.abs(maxDim/2/Math.tan(fov/2));cameraZ*=1.5,this.camera.position.set(center.x,center.y,center.z+cameraZ),this.controls.target.copy(center),this.controls.update()}animate(){this.renderer.setAnimationLoop((()=>{this.isAutoRotating&&this.model&&(this.model.rotation.y+=.005),this.controls.update(),this.renderer.render(this.scene,this.camera)}))}onResize(){var width=this.container.clientWidth,height=this.container.clientHeight;this.camera.aspect=width/height,this.camera.updateProjectionMatrix(),this.renderer.setSize(width,height)}toggleFullscreen(){var icon;this.container.closest(".gear-viewer-container").classList.toggle("fullscreen"),this.isFullscreen=!this.isFullscreen,(icon=document.getElementById("gear-fullscreen-"+this.cmid).querySelector("i")).classList.toggle("fa-expand",!this.isFullscreen),icon.classList.toggle("fa-compress",this.isFullscreen),setTimeout((()=>this.onResize()),100)}toggleAutoRotate(){this.isAutoRotating=!this.isAutoRotating,document.getElementById("gear-autorotate-"+this.cmid).classList.toggle("active",this.isAutoRotating)}async startARSession(){var session,eventDetail;try{session=await navigator.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","local-floor"]}),this.renderer.xr.setSession(session),eventDetail={cmid:this.cmid},document.dispatchEvent(new CustomEvent("gear:ar:started",{detail:eventDetail})),this.trackEvent("ar_start")}catch(error){Notification.exception(error)}}async startVRSession(){var session,eventDetail;try{session=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}),this.renderer.xr.setSession(session),eventDetail={cmid:this.cmid},document.dispatchEvent(new CustomEvent("gear:vr:started",{detail:eventDetail})),this.trackEvent("vr_start")}catch(error){Notification.exception(error)}}trackEvent(action){let data=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Ajax.call([{methodname:"mod_gear_track_event",args:{gearid:this.gearid,action:action,data:JSON.stringify(data)}}])}setupRaycaster(){this.raycaster=new THREE.Raycaster,this.canvas.addEventListener("click",(event=>{var rect=this.canvas.getBoundingClientRect();this.mouse.x=(event.clientX-rect.left)/rect.width*2-1,this.mouse.y=-(event.clientY-rect.top)/rect.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);var intersects=this.raycaster.intersectObjects(this.hotspotMeshes);if(intersects.length>0){var hotspotMesh=intersects[0].object;this.showHotspotPopup(hotspotMesh.userData)}}))}loadHotspots(){var geometry,material,sphere,pos;if(this.hotspotsData&&0!==this.hotspotsData.length){geometry=new THREE.SphereGeometry(.08,16,16),material=new THREE.MeshBasicMaterial({color:6514417,transparent:!0,opacity:.9});for(const hotspot of this.hotspotsData)sphere=new THREE.Mesh(geometry,material.clone()),pos=hotspot.position||{x:0,y:0,z:0},sphere.position.set(pos.x,pos.y,pos.z),sphere.userData=hotspot,this.scene.add(sphere),this.hotspotMeshes.push(sphere)}}showHotspotPopup(hotspot){var title,content,popup=document.getElementById("gear-hotspot-popup-"+this.cmid);popup||((popup=document.createElement("div")).id="gear-hotspot-popup-"+this.cmid,popup.className="gear-hotspot-popup",popup.innerHTML='<div class="gear-hotspot-popup-inner"><button class="gear-hotspot-close" aria-label="Close">&times;</button><h4 class="gear-hotspot-title"></h4><div class="gear-hotspot-content"></div></div>',this.container.appendChild(popup),popup.querySelector(".gear-hotspot-close").addEventListener("click",(()=>{popup.classList.remove("active")}))),title=popup.querySelector(".gear-hotspot-title"),content=popup.querySelector(".gear-hotspot-content"),title.textContent=hotspot.title||"Info",content.innerHTML=hotspot.content||"",popup.classList.add("active"),this.trackInteraction("hotspot_click",{hotspot_id:hotspot.id,title:hotspot.title})}}return{init:function(options){new GearViewer(options)}}}));

//# sourceMappingURL=viewer.min.js.map