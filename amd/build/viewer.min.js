define(["jquery","core/ajax","core/notification","core/str"],function(t,s,p,e){class i{constructor(t){this.cmid=t.cmid,this.gearid=t.gearid,this.config=t.config||{},this.config.hotspots&&void 0!==this.config.hotspots.enabled?this.hotspotsEnabled=!!this.config.hotspots.enabled:this.hotspotsEnabled=!0,this.hotspotsEditable=this.config.hotspots&&!!this.config.hotspots.edit||!1,this.arEnabled=t.ar_enabled||!1,this.vrEnabled=t.vr_enabled||!1,this.modelsData=t.models||[],this.hotspotsData=t.hotspots||[],this.canManage=t.canmanage||!1,this.container=document.getElementById("gear-viewer-"+this.cmid),this.canvas=document.getElementById("gear-canvas-"+this.cmid),this.isFullscreen=!1,this.isAutoRotating=!1,this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.model=null,this.hotspotMeshes=[],this.raycaster=null,this.mouse=new THREE.Vector2,this.init()}async init(){try{await this.loadThreeJS(),this.setupScene(),this.setupControls(),this.setupRaycaster(),this.setupEventListeners(),this.loadModels(),this.hotspotsEnabled&&this.loadHotspots(),this.animate();var t={cmid:this.cmid,gearid:this.gearid};document.dispatchEvent(new CustomEvent("gear:scene:loaded",{detail:t}))}catch(t){p.exception(t)}}async loadThreeJS(){if("undefined"==typeof THREE&&await new Promise(t=>setTimeout(t,500)),"undefined"==typeof THREE)throw new Error("Three.js not loaded. Please check view.php.")}setupScene(){var t;this.scene=new THREE.Scene,t=this.config.background||"#1a1a2e",this.scene.background=new THREE.Color(t),t=this.container.clientWidth/this.container.clientHeight,this.camera=new THREE.PerspectiveCamera(75,t,.1,1e3),t=this.config.camera?.position||[0,1.6,3],this.camera.position.set(t[0],t[1],t[2]),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0,alpha:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.outputEncoding=THREE.sRGBEncoding,this.renderer.xr.enabled=!0,this.setupLighting(),window.addEventListener("resize",()=>this.onResize())}setupLighting(){var t,e=this.config.lighting||"studio",s=new THREE.AmbientLight(16777215,.5);switch(this.scene.add(s),e){case"studio":(t=new THREE.DirectionalLight(16777215,1)).position.set(5,5,5),this.scene.add(t),(t=new THREE.DirectionalLight(16777215,.5)).position.set(-5,0,5),this.scene.add(t),(t=new THREE.DirectionalLight(16777215,.3)).position.set(0,5,-5),this.scene.add(t);break;case"outdoor":(t=new THREE.DirectionalLight(16777164,1.2)).position.set(10,10,5),this.scene.add(t),t=new THREE.HemisphereLight(8900331,4021340,.6),this.scene.add(t);break;case"dark":(t=new THREE.SpotLight(16777215,.8)).position.set(0,5,0),this.scene.add(t)}}setupControls(){this.controls=new THREE.OrbitControls(this.camera,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=.5,this.controls.maxDistance=50,this.controls.maxPolarAngle=Math.PI}setupEventListeners(){var t=document.getElementById("gear-fullscreen-"+this.cmid);t&&t.addEventListener("click",()=>this.toggleFullscreen()),(t=document.getElementById("gear-autorotate-"+this.cmid))&&t.addEventListener("click",()=>this.toggleAutoRotate()),(t=document.getElementById("gear-ar-"+this.cmid))&&this.arEnabled&&this.setupARButton(t),(t=document.getElementById("gear-vr-"+this.cmid))&&this.vrEnabled&&this.setupVRButton(t)}async setupARButton(t){"xr"in navigator?await navigator.xr.isSessionSupported("immersive-ar")?t.addEventListener("click",()=>this.startARSession()):(t.disabled=!0,t.title=await e.get_string("arnotsupported","mod_gear")):t.disabled=!0}async setupVRButton(t){"xr"in navigator?await navigator.xr.isSessionSupported("immersive-vr")?t.addEventListener("click",()=>this.startVRSession()):(t.disabled=!0,t.title=await e.get_string("webxrnotsupported","mod_gear")):t.disabled=!0}async loadModels(){var i,t;try{if(this.modelsData&&0<this.modelsData.length){i=new THREE.GLTFLoader;for(let s of this.modelsData)t=await new Promise((t,e)=>{i.load(s.url,t,void 0,e)}),this.model=t.scene,this.model.scale.setScalar(1),this.scene.add(this.model),this.centerCameraOnModel(this.model)}else this.addPlaceholderModel();this.container.classList.add("loaded")}catch(t){window.console.error("GEAR: Error loading model:",t),this.addPlaceholderModel(),this.container.classList.add("loaded")}}addPlaceholderModel(){var t=new THREE.BoxGeometry(1,1,1),e=new THREE.MeshStandardMaterial({color:4886745,metalness:.3,roughness:.4});this.model=new THREE.Mesh(t,e),this.scene.add(this.model)}centerCameraOnModel(t){var t=(new THREE.Box3).setFromObject(t),e=t.getCenter(new THREE.Vector3),t=t.getSize(new THREE.Vector3),t=Math.max(t.x,t.y,t.z),s=this.camera.fov*(Math.PI/180),t=Math.abs(t/2/Math.tan(s/2));this.camera.position.set(e.x,e.y,e.z+(t*=1.5)),this.controls.target.copy(e),this.controls.update()}animate(){this.renderer.setAnimationLoop(()=>{this.isAutoRotating&&this.model&&(this.model.rotation.y+=.005),this.controls.update(),this.renderer.render(this.scene,this.camera)})}onResize(){var t=this.container.clientWidth,e=this.container.clientHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}toggleFullscreen(){var t;this.container.closest(".gear-viewer-container").classList.toggle("fullscreen"),this.isFullscreen=!this.isFullscreen,(t=document.getElementById("gear-fullscreen-"+this.cmid).querySelector("i")).classList.toggle("fa-expand",!this.isFullscreen),t.classList.toggle("fa-compress",this.isFullscreen),setTimeout(()=>this.onResize(),100)}toggleAutoRotate(){this.isAutoRotating=!this.isAutoRotating,document.getElementById("gear-autorotate-"+this.cmid).classList.toggle("active",this.isAutoRotating)}async startARSession(){var t,e;try{t=await navigator.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","local-floor"]}),this.renderer.xr.setSession(t),e={cmid:this.cmid},document.dispatchEvent(new CustomEvent("gear:ar:started",{detail:e})),this.trackEvent("ar_start")}catch(t){p.exception(t)}}async startVRSession(){var t,e;try{t=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}),this.renderer.xr.setSession(t),e={cmid:this.cmid},document.dispatchEvent(new CustomEvent("gear:vr:started",{detail:e})),this.trackEvent("vr_start")}catch(t){p.exception(t)}}trackEvent(t,e={}){s.call([{methodname:"mod_gear_track_event",args:{gearid:this.gearid,action:t,data:JSON.stringify(e)}}])}setupRaycaster(){this.raycaster=new THREE.Raycaster,this.canvas.addEventListener("click",t=>{var e=this.canvas.getBoundingClientRect();if(this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-(t.clientY-e.top)/e.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera),t.shiftKey&&this.canManage&&this.model&&this.hotspotsEnabled){e=this.raycaster.intersectObject(this.model,!0);if(0<e.length)return t=e[0].point,void this.showAddHotspotForm(t)}e=this.raycaster.intersectObjects(this.hotspotMeshes);0<e.length&&(t=e[0].object,this.showHotspotPopup(t.userData))})}loadHotspots(){var t,e,s,i;if(this.hotspotsData&&0!==this.hotspotsData.length){t=new THREE.SphereGeometry(.08,16,16),e=new THREE.MeshBasicMaterial({color:6514417,transparent:!0,opacity:.9});for(var o of this.hotspotsData)s=new THREE.Mesh(t,e.clone()),i=o.position||{x:0,y:0,z:0},s.position.set(i.x,i.y,i.z),s.userData=o,this.scene.add(s),this.hotspotMeshes.push(s)}}showHotspotPopup(e){var t,s,i=document.getElementById("gear-hotspot-popup-"+this.cmid);i||((i=document.createElement("div")).id="gear-hotspot-popup-"+this.cmid,i.className="gear-hotspot-popup",i.innerHTML='<div class="gear-hotspot-popup-inner"><button class="gear-hotspot-close" aria-label="Close">&times;</button><h4 class="gear-hotspot-title"></h4><div class="gear-hotspot-content"></div></div>',this.container.appendChild(i),i.querySelector(".gear-hotspot-close").addEventListener("click",()=>{i.classList.remove("active")})),s=i.querySelector(".gear-hotspot-title"),t=i.querySelector(".gear-hotspot-content"),s.textContent=e.title||"Info",t.innerHTML=e.content||"",this.canManage&&this.hotspotsEditable&&((s=document.createElement("button")).className="btn btn-secondary gear-edit-hotspot",s.textContent="Edit",s.style.marginLeft="0.5rem",s.addEventListener("click",()=>{var t=e.position||{x:0,y:0,z:0};this.showAddHotspotForm({x:t.x,y:t.y,z:t.z},e),i.classList.remove("active")}),(i.querySelector(".gear-hotspot-title")||i.querySelector(".gear-hotspot-popup-inner")).appendChild(s)),i.classList.add("active"),"function"==typeof this.trackInteraction&&this.trackInteraction("hotspot_click",{hotspotId:e.id,title:e.title})}showAddHotspotForm(t,e){var s=document.getElementById("gear-hotspot-form-"+this.cmid);s?(s.querySelector("#gear-hotspot-input-title-"+this.cmid).value="",s.querySelector("#gear-hotspot-input-content-"+this.cmid).value="",s.removeAttribute("data-hotspot-id"),s.classList.add("active")):((s=document.createElement("div")).id="gear-hotspot-form-"+this.cmid,s.className="gear-hotspot-popup active",s.innerHTML='<div class="gear-hotspot-popup-inner gear-hotspot-form-inner"><h4 class="gear-hotspot-title">Add Hotspot</h4><div class="gear-form-group"><label for="gear-hotspot-input-title-'+this.cmid+'">Title</label><input type="text" id="gear-hotspot-input-title-'+this.cmid+'" class="form-control" placeholder="Enter title"></div><div class="gear-form-group"><label for="gear-hotspot-input-content-'+this.cmid+'">Content</label><textarea id="gear-hotspot-input-content-'+this.cmid+'" class="form-control" rows="3" placeholder="Enter content"></textarea></div><div class="gear-form-actions"><button type="button" class="btn btn-secondary gear-cancel-btn">Cancel</button><button type="button" class="btn btn-primary gear-save-btn">Save</button></div></div>',this.container.appendChild(s),s.querySelector(".gear-cancel-btn").addEventListener("click",()=>{s.classList.remove("active")})),e?(s.querySelector("#gear-hotspot-input-title-"+this.cmid).value=e.title||"",s.querySelector("#gear-hotspot-input-content-"+this.cmid).value=e.content||"",s.dataset.hotspotId=e.id,s.dataset.posX=(e=e.position||t).x.toFixed(3),s.dataset.posY=e.y.toFixed(3),s.dataset.posZ=e.z.toFixed(3)):(s.dataset.posX=t.x.toFixed(3),s.dataset.posY=t.y.toFixed(3),s.dataset.posZ=t.z.toFixed(3)),s.querySelector(".gear-save-btn").onclick=()=>this.saveNewHotspot(s)}saveNewHotspot(r){var c,t=r.querySelector("#gear-hotspot-input-title-"+this.cmid),e=r.querySelector("#gear-hotspot-input-content-"+this.cmid),h=t.value.trim(),d=e.value.trim(),l={x:parseFloat(r.dataset.posX),y:parseFloat(r.dataset.posY),z:parseFloat(r.dataset.posZ)};h?(c=r.dataset.hotspotId?parseInt(r.dataset.hotspotId,10):0,s.call([{methodname:"mod_gear_save_hotspot",args:{id:c,gearid:this.gearid,modelid:0,type:"info",title:h,content:d,position:JSON.stringify(l),icon:"info"}}])[0].then(t=>{var e=new THREE.SphereGeometry(.08,16,16),s=new THREE.MeshBasicMaterial({color:6514417,transparent:!0,opacity:.9});if(c&&0<c){for(var i=!1,o=0;o<this.hotspotMeshes.length;o++){var a=this.hotspotMeshes[o];if(a.userData&&a.userData.id==c){a.userData.title=h,a.userData.content=d,a.position.set(l.x,l.y,l.z),i=!0;break}}i||((n=new THREE.Mesh(e,s)).position.set(l.x,l.y,l.z),n.userData={id:t.id,title:h,content:d,type:"info"},this.scene.add(n),this.hotspotMeshes.push(n))}else{var n=new THREE.Mesh(e,s);n.position.set(l.x,l.y,l.z),n.userData={id:t.id,title:h,content:d,type:"info"},this.scene.add(n),this.hotspotMeshes.push(n)}return r.classList.remove("active"),p.addNotification({message:"Hotspot saved successfully",type:"success"}),t}).catch(p.exception)):p.alert("Error","Please enter a title")}}return{init:function(t){new i(t)}}});
//# sourceMappingURL=viewer.min.js.map