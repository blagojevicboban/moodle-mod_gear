/**
 * GEAR Viewer - Main JavaScript module for 3D/AR/VR viewing.
 *
 * @module     mod_gear/viewer
 * @copyright  2026 Boban Blagojevic
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str"],(function(e,t,i,s){"use strict";class n{constructor(e){this.cmid=e.cmid,this.gearid=e.gearid,this.config=e.config||{},this.arEnabled=e.ar_enabled||!1,this.vrEnabled=e.vr_enabled||!1,this.container=document.getElementById("gear-viewer-"+this.cmid),this.canvas=document.getElementById("gear-canvas-"+this.cmid),this.isFullscreen=!1,this.isAutoRotating=!1,this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.model=null,this.init()}async init(){try{await this.loadThreeJS(),this.setupScene(),this.setupControls(),this.setupEventListeners(),this.loadModels(),this.animate();var e={cmid:this.cmid,gearid:this.gearid};document.dispatchEvent(new CustomEvent("gear:scene:loaded",{detail:e}))}catch(e){i.exception(e)}}async loadThreeJS(){"undefined"==typeof THREE&&(await this.loadScript("https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"),await this.loadScript("https://cdn.jsdelivr.net/npm/three@0.150.0/examples/js/controls/OrbitControls.js"),await this.loadScript("https://cdn.jsdelivr.net/npm/three@0.150.0/examples/js/loaders/GLTFLoader.js"))}loadScript(e){return new Promise(((t,i)=>{var s=document.createElement("script");s.src=e,s.onload=t,s.onerror=i,document.head.appendChild(s)}))}setupScene(){var e,t,i;this.scene=new THREE.Scene,e=this.config.background||"#1a1a2e",this.scene.background=new THREE.Color(e),t=this.container.clientWidth/this.container.clientHeight,this.camera=new THREE.PerspectiveCamera(75,t,.1,1e3),i=this.config.camera?.position||[0,1.6,3],this.camera.position.set(i[0],i[1],i[2]),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0,alpha:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.outputEncoding=THREE.sRGBEncoding,this.renderer.xr.enabled=!0,this.setupLighting(),window.addEventListener("resize",(()=>this.onResize()))}setupLighting(){var e,t,i,s,n,a,r,o=this.config.lighting||"studio";switch(e=new THREE.AmbientLight(16777215,.5),this.scene.add(e),o){case"studio":(t=new THREE.DirectionalLight(16777215,1)).position.set(5,5,5),this.scene.add(t),(i=new THREE.DirectionalLight(16777215,.5)).position.set(-5,0,5),this.scene.add(i),(s=new THREE.DirectionalLight(16777215,.3)).position.set(0,5,-5),this.scene.add(s);break;case"outdoor":(n=new THREE.DirectionalLight(16777164,1.2)).position.set(10,10,5),this.scene.add(n),a=new THREE.HemisphereLight(8900331,4021340,.6),this.scene.add(a);break;case"dark":(r=new THREE.SpotLight(16777215,.8)).position.set(0,5,0),this.scene.add(r)}}setupControls(){this.controls=new THREE.OrbitControls(this.camera,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=.5,this.controls.maxDistance=50,this.controls.maxPolarAngle=Math.PI}setupEventListeners(){var e,t,i,s;(e=document.getElementById("gear-fullscreen-"+this.cmid))&&e.addEventListener("click",(()=>this.toggleFullscreen())),(t=document.getElementById("gear-autorotate-"+this.cmid))&&t.addEventListener("click",(()=>this.toggleAutoRotate())),(i=document.getElementById("gear-ar-"+this.cmid))&&this.arEnabled&&this.setupARButton(i),(s=document.getElementById("gear-vr-"+this.cmid))&&this.vrEnabled&&this.setupVRButton(s)}async setupARButton(e){"xr"in navigator?await navigator.xr.isSessionSupported("immersive-ar")?e.addEventListener("click",(()=>this.startARSession())):(e.disabled=!0,e.title=await s.get_string("arnotsupported","mod_gear")):e.disabled=!0}async setupVRButton(e){"xr"in navigator?await navigator.xr.isSessionSupported("immersive-vr")?e.addEventListener("click",(()=>this.startVRSession())):(e.disabled=!0,e.title=await s.get_string("webxrnotsupported","mod_gear")):e.disabled=!0}async loadModels(){var e,i,s,n,a;try{if((e=await t.call([{methodname:"mod_gear_get_models",args:{gearid:this.gearid}}])[0]).models&&e.models.length>0){i=new THREE.GLTFLoader;for(const t of e.models)s=await new Promise(((e,s)=>{i.load(t.url,e,void 0,s)})),this.model=s.scene,t.position&&(n=JSON.parse(t.position),this.model.position.set(n.x||0,n.y||0,n.z||0)),t.rotation&&(a=JSON.parse(t.rotation),this.model.rotation.set(a.x||0,a.y||0,a.z||0)),t.scale&&this.model.scale.setScalar(t.scale),this.scene.add(this.model),this.centerCameraOnModel(this.model)}this.container.classList.add("loaded")}catch(e){this.addPlaceholderModel(),this.container.classList.add("loaded")}}addPlaceholderModel(){var e=new THREE.BoxGeometry(1,1,1),t=new THREE.MeshStandardMaterial({color:4886745,metalness:.3,roughness:.4});this.model=new THREE.Mesh(e,t),this.scene.add(this.model)}centerCameraOnModel(e){var t=(new THREE.Box3).setFromObject(e),i=t.getCenter(new THREE.Vector3),s=t.getSize(new THREE.Vector3),n=Math.max(s.x,s.y,s.z),a=this.camera.fov*(Math.PI/180),r=Math.abs(n/2/Math.tan(a/2));r*=1.5,this.camera.position.set(i.x,i.y,i.z+r),this.controls.target.copy(i),this.controls.update()}animate(){this.renderer.setAnimationLoop((()=>{this.isAutoRotating&&this.model&&(this.model.rotation.y+=.005),this.controls.update(),this.renderer.render(this.scene,this.camera)}))}onResize(){var e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}toggleFullscreen(){var e;this.container.closest(".gear-viewer-container").classList.toggle("fullscreen"),this.isFullscreen=!this.isFullscreen,(e=document.getElementById("gear-fullscreen-"+this.cmid).querySelector("i")).classList.toggle("fa-expand",!this.isFullscreen),e.classList.toggle("fa-compress",this.isFullscreen),setTimeout((()=>this.onResize()),100)}toggleAutoRotate(){this.isAutoRotating=!this.isAutoRotating,document.getElementById("gear-autorotate-"+this.cmid).classList.toggle("active",this.isAutoRotating)}async startARSession(){var e,t;try{e=await navigator.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","local-floor"]}),this.renderer.xr.setSession(e),t={cmid:this.cmid},document.dispatchEvent(new CustomEvent("gear:ar:started",{detail:t})),this.trackEvent("ar_start")}catch(e){i.exception(e)}}async startVRSession(){var e,t;try{e=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}),this.renderer.xr.setSession(e),t={cmid:this.cmid},document.dispatchEvent(new CustomEvent("gear:vr:started",{detail:t})),this.trackEvent("vr_start")}catch(e){i.exception(e)}}trackEvent(e,i={}){t.call([{methodname:"mod_gear_track_event",args:{gearid:this.gearid,action:e,data:JSON.stringify(i)}}])}}return{init:function(e){new n(e)}}}));
